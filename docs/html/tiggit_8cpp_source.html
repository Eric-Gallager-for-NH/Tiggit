<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Tiggit: tiggit.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tiggit
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">tiggit.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#define wxUSE_UNICODE 1</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;wx/wx.h&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;wx/stdpaths.h&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;wx/listctrl.h&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;wx/accel.h&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;wx/imaglist.h&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;wx/notebook.h&gt;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;image_viewer.hpp&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;decodeurl.hpp&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;filegetter.hpp&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;data_reader.hpp&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;downloadjob.hpp&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;zipjob.hpp&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;jobqueue.hpp&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;json_installed.hpp&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;auto_update.hpp&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;listkeeper.hpp&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;auth.hpp&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;json_rated.hpp&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;gameinfo.hpp&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;cache_fetcher.hpp&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;tag_sorter.hpp&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;tabbase.hpp&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;newstab.hpp&quot;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="keyword">using namespace </span>std;
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <a class="code" href="struct_data_list.html">DataList</a> data;
<a name="l00035"></a>00035 <a class="code" href="struct_json_installed.html">JsonInstalled</a> jinst;
<a name="l00036"></a>00036 <a class="code" href="struct_tig_list_reader.html">TigListReader</a> tig_reader;
<a name="l00037"></a>00037 <a class="code" href="struct_tag_sorter.html">TagSorter</a> tagSorter;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="comment">// Temporary hack</span>
<a name="l00040"></a>00040 <span class="keywordtype">bool</span> gHasDemos = <span class="keyword">false</span>;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="comment">// Update data from all_games.json. If the parameter is true, force</span>
<a name="l00043"></a>00043 <span class="comment">// download. If not, download only if the existing file is too old.</span>
<a name="l00044"></a>00044 <span class="keywordtype">void</span> updateData(<span class="keywordtype">bool</span> download)
<a name="l00045"></a>00045 {
<a name="l00046"></a>00046   <span class="comment">// This is bad and kinda leaks memory like hell (because of all the</span>
<a name="l00047"></a>00047   <span class="comment">// GameInfo instances.) But refreshes are kinda not an integral part</span>
<a name="l00048"></a>00048   <span class="comment">// of the application at the moment, so just ignore it for now.</span>
<a name="l00049"></a>00049   data.arr.resize(0);
<a name="l00050"></a>00050 
<a name="l00051"></a>00051   <span class="keywordtype">string</span> lstfile = <span class="keyword">get</span>.getPath(<span class="stringliteral">&quot;all_games.json&quot;</span>);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053   <span class="comment">// Do we check file age?</span>
<a name="l00054"></a>00054   <span class="keywordflow">if</span>(!download &amp;&amp; boost::filesystem::exists(lstfile))
<a name="l00055"></a>00055     {
<a name="l00056"></a>00056       <span class="comment">// Yup, check file age</span>
<a name="l00057"></a>00057       time_t ft = boost::filesystem::last_write_time(lstfile);
<a name="l00058"></a>00058       time_t now = time(0);
<a name="l00059"></a>00059 
<a name="l00060"></a>00060       <span class="comment">// update game list once an hour</span>
<a name="l00061"></a>00061       <span class="keywordflow">if</span>(difftime(now,ft) &gt; 60*60*1)
<a name="l00062"></a>00062         download = <span class="keyword">true</span>;
<a name="l00063"></a>00063     }
<a name="l00064"></a>00064   <span class="keywordflow">else</span>
<a name="l00065"></a>00065     <span class="comment">// If the file didn&#39;t exist, download it.</span>
<a name="l00066"></a>00066     download = <span class="keyword">true</span>;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068   <span class="keywordflow">if</span>(download)
<a name="l00069"></a>00069     {
<a name="l00070"></a>00070       <span class="keywordflow">try</span>
<a name="l00071"></a>00071         {
<a name="l00072"></a>00072           <span class="comment">// Get the latest list from the net</span>
<a name="l00073"></a>00073           <span class="keywordtype">string</span> url = <span class="stringliteral">&quot;http://tiggit.net/api/all_games.json&quot;</span>;
<a name="l00074"></a>00074           <span class="keyword">get</span>.getTo(url, <span class="stringliteral">&quot;all_games.json&quot;</span>);
<a name="l00075"></a>00075         }
<a name="l00076"></a>00076       <span class="keywordflow">catch</span>(...) {}
<a name="l00077"></a>00077     }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079   <span class="keywordflow">try</span>
<a name="l00080"></a>00080     {
<a name="l00081"></a>00081       tig_reader.loadData(lstfile, data);
<a name="l00082"></a>00082       jinst.read(data);
<a name="l00083"></a>00083       tagSorter.process(data);
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085   <span class="keywordflow">catch</span>(std::exception &amp;e)
<a name="l00086"></a>00086     {
<a name="l00087"></a>00087       <span class="comment">// Did we already try downloading?</span>
<a name="l00088"></a>00088       <span class="keywordflow">if</span>(download)
<a name="l00089"></a>00089         {
<a name="l00090"></a>00090           <span class="comment">// Then fail, nothing more to do</span>
<a name="l00091"></a>00091           wxString msg(e.what(), wxConvUTF8);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093           <span class="comment">// Make sure we delete the file - no point in keeping an</span>
<a name="l00094"></a>00094           <span class="comment">// invalid cache.</span>
<a name="l00095"></a>00095           boost::filesystem::remove(lstfile);
<a name="l00096"></a>00096 
<a name="l00097"></a>00097           wxMessageBox(msg, wxT(<span class="stringliteral">&quot;Error&quot;</span>), wxOK | wxICON_ERROR);
<a name="l00098"></a>00098         }
<a name="l00099"></a>00099       <span class="keywordflow">else</span>
<a name="l00100"></a>00100         <span class="comment">// Nope. Try again, this time force a download.</span>
<a name="l00101"></a>00101         updateData(<span class="keyword">true</span>);
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="struct_column_handler.html">00105</a> <span class="keyword">struct </span><a class="code" href="struct_column_handler.html">ColumnHandler</a>
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107   <span class="keyword">virtual</span> wxString getText(<a class="code" href="struct_game_info.html">GameInfo</a> &amp;e) = 0;
<a name="l00108"></a>00108 };
<a name="l00109"></a>00109 
<a name="l00110"></a><a class="code" href="class_my_list.html">00110</a> <span class="keyword">class </span><a class="code" href="class_my_list.html">MyList</a> : <span class="keyword">public</span> wxListCtrl
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112   wxListItemAttr green, orange;
<a name="l00113"></a>00113   wxImageList images;
<a name="l00114"></a>00114   <a class="code" href="class_list_keeper.html">ListKeeper</a> &amp;lister;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116   std::vector&lt;ColumnHandler*&gt; colHands;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118   <span class="comment">// Number of columns</span>
<a name="l00119"></a>00119   <span class="keywordtype">int</span> colNum;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="keyword">public</span>:
<a name="l00122"></a>00122   <a class="code" href="class_my_list.html">MyList</a>(wxWindow *parent, <span class="keywordtype">int</span> ID, <a class="code" href="class_list_keeper.html">ListKeeper</a> &amp;lst)
<a name="l00123"></a>00123     : wxListCtrl(parent, ID, wxDefaultPosition, wxDefaultSize,
<a name="l00124"></a>00124                  wxBORDER_SUNKEN | wxLC_REPORT | wxLC_VIRTUAL | wxLC_SINGLE_SEL),
<a name="l00125"></a>00125       lister(lst), colNum(0)
<a name="l00126"></a>00126   {
<a name="l00127"></a>00127     green.SetBackgroundColour(wxColour(180,255,180));
<a name="l00128"></a>00128     green.SetTextColour(wxColour(0,0,0));
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     orange.SetBackgroundColour(wxColour(255,240,180));
<a name="l00131"></a>00131     orange.SetTextColour(wxColour(0,0,0));
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="comment">/* For later. Works, but doesn&#39;t look good.</span>
<a name="l00134"></a>00134 <span class="comment">    images.Create(80,50,false);</span>
<a name="l00135"></a>00135 <span class="comment">    SetImageList(&amp;images, wxIMAGE_LIST_SMALL);</span>
<a name="l00136"></a>00136 <span class="comment"></span>
<a name="l00137"></a>00137 <span class="comment">    wxImage::AddHandler(new wxPNGHandler);</span>
<a name="l00138"></a>00138 <span class="comment">    wxImage img(wxT(&quot;tmp.png&quot;));</span>
<a name="l00139"></a>00139 <span class="comment">    wxBitmap bmp(img);</span>
<a name="l00140"></a>00140 <span class="comment">    images.Add(bmp);</span>
<a name="l00141"></a>00141 <span class="comment">    */</span>
<a name="l00142"></a>00142   }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   <span class="keywordtype">void</span> addColumn(<span class="keyword">const</span> wxString &amp;name, <span class="keywordtype">int</span> width, <a class="code" href="struct_column_handler.html">ColumnHandler</a> *ch)
<a name="l00145"></a>00145   {
<a name="l00146"></a>00146     colHands.push_back(ch);
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     wxListItem col;
<a name="l00149"></a>00149     col.SetId(colNum);
<a name="l00150"></a>00150     col.SetText(name);
<a name="l00151"></a>00151     col.SetWidth(width);
<a name="l00152"></a>00152     InsertColumn(colNum, col);
<a name="l00153"></a>00153     colNum++;
<a name="l00154"></a>00154   }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   <span class="keywordtype">void</span> setSelect(<span class="keywordtype">int</span> index)
<a name="l00157"></a>00157   {
<a name="l00158"></a>00158     SetItemState(index, wxLIST_STATE_SELECTED, wxLIST_STATE_SELECTED);
<a name="l00159"></a>00159   }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   <span class="comment">// Refresh the list based on new data. If stay=true, then try to</span>
<a name="l00162"></a>00162   <span class="comment">// stay at or near the old list position.</span>
<a name="l00163"></a>00163   <span class="keywordtype">void</span> update(<span class="keywordtype">bool</span> stay=<span class="keyword">false</span>)
<a name="l00164"></a>00164   {
<a name="l00165"></a>00165     <span class="keywordtype">int</span> newItem = 0;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     <span class="keywordflow">if</span>(stay)
<a name="l00168"></a>00168       {
<a name="l00169"></a>00169         newItem = GetNextItem(-1, wxLIST_NEXT_ALL, wxLIST_STATE_SELECTED);
<a name="l00170"></a>00170         <span class="keywordflow">if</span>(newItem &lt; 0) newItem = 0;
<a name="l00171"></a>00171       }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     SetItemCount(lister.size());
<a name="l00174"></a>00174     <span class="keywordflow">if</span>(newItem &gt;= lister.size())
<a name="l00175"></a>00175       newItem = lister.size() - 1;
<a name="l00176"></a>00176     setSelect(newItem);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <span class="comment">// Doesn&#39;t seem to be needed on Linux. We could remove it there to</span>
<a name="l00179"></a>00179     <span class="comment">// make it a slightly less flickering experience.</span>
<a name="l00180"></a>00180     Refresh();
<a name="l00181"></a>00181   }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183   wxListItemAttr *OnGetItemAttr(<span class="keywordtype">long</span> item)<span class="keyword"> const</span>
<a name="l00184"></a>00184 <span class="keyword">  </span>{
<a name="l00185"></a>00185     <span class="keywordflow">if</span>(item &lt; 0 || item &gt;= lister.size())
<a name="l00186"></a>00186       <span class="keywordflow">return</span> NULL;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <a class="code" href="struct_game_info.html">GameInfo</a> &amp;g = GameInfo::conv(lister.get(item));
<a name="l00189"></a>00189     <span class="keywordflow">if</span>(g.isNone()) <span class="keywordflow">return</span> NULL;
<a name="l00190"></a>00190     <span class="keywordflow">if</span>(g.isInstalled()) <span class="keywordflow">return</span> NULL;
<a name="l00191"></a>00191     <span class="keywordflow">return</span> (wxListItemAttr*)&amp;orange;
<a name="l00192"></a>00192   }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194   <span class="keywordtype">int</span> OnGetItemImage(<span class="keywordtype">long</span> item)<span class="keyword"> const</span>
<a name="l00195"></a>00195 <span class="keyword">  </span>{
<a name="l00196"></a>00196     <span class="keywordflow">return</span> -1;
<a name="l00197"></a>00197   }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199   <span class="keywordtype">int</span> OnGetColumnImage(<span class="keywordtype">long</span> item, <span class="keywordtype">long</span> column)<span class="keyword"> const</span>
<a name="l00200"></a>00200 <span class="keyword">  </span>{
<a name="l00201"></a>00201     <span class="keywordflow">return</span> -1;
<a name="l00202"></a>00202   }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204   wxString OnGetItemText(<span class="keywordtype">long</span> item, <span class="keywordtype">long</span> column)<span class="keyword"> const</span>
<a name="l00205"></a>00205 <span class="keyword">  </span>{
<a name="l00206"></a>00206     <span class="keywordflow">if</span>(column &lt; 0 || column &gt;= colHands.size() ||
<a name="l00207"></a>00207        item &lt; 0 || item &gt;= lister.size())
<a name="l00208"></a>00208       <span class="keywordflow">return</span> wxT(<span class="stringliteral">&quot;No info&quot;</span>);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     assert(column &gt;= 0 &amp;&amp; column &lt; colHands.size());
<a name="l00211"></a>00211     <a class="code" href="struct_column_handler.html">ColumnHandler</a> *h = colHands[column];
<a name="l00212"></a>00212     assert(h);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="keywordflow">return</span> h-&gt;getText(GameInfo::conv(lister.get(item)));
<a name="l00215"></a>00215   }
<a name="l00216"></a>00216 };
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="comment">// Ask the user an OK/Cancel question.</span>
<a name="l00219"></a>00219 <span class="keywordtype">bool</span> ask(<span class="keyword">const</span> wxString &amp;question)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221   <span class="keywordflow">return</span> wxMessageBox(question, wxT(<span class="stringliteral">&quot;Please confirm&quot;</span>),
<a name="l00222"></a>00222                       wxOK | wxCANCEL | wxICON_QUESTION) == wxOK;
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="comment">// Display an error message box</span>
<a name="l00226"></a>00226 <span class="keywordtype">void</span> errorBox(<span class="keyword">const</span> wxString &amp;msg)
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228   wxMessageBox(msg, wxT(<span class="stringliteral">&quot;Error&quot;</span>), wxOK | wxICON_ERROR);
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 <span class="preprocessor">#define myID_BUTTON1 21</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span><span class="preprocessor">#define myID_BUTTON2 22</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span><span class="preprocessor">#define myID_SUPPORT 23</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span><span class="preprocessor">#define myID_GAMEPAGE 24</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span><span class="preprocessor">#define myID_LIST 25</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span><span class="preprocessor">#define myID_RATE 26</span>
<a name="l00237"></a>00237 <span class="preprocessor"></span><span class="preprocessor">#define myID_TEXTVIEW 27</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span><span class="preprocessor">#define myID_SCREENSHOT 28</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span><span class="preprocessor">#define myID_SORT_TITLE 41</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span><span class="preprocessor">#define myID_SORT_DATE 42</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span><span class="preprocessor">#define myID_SORT_REVERSE 43</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span><span class="preprocessor">#define myID_SORT_RATING 44</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span><span class="preprocessor">#define myID_SEARCH_BOX 45</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span>
<a name="l00245"></a>00245 <span class="preprocessor">#define myID_TIGGIT_PAGE 20010</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span><span class="preprocessor">#define myID_OPEN_LOCATION 20011</span>
<a name="l00247"></a>00247 <span class="preprocessor"></span><span class="preprocessor">#define myID_REFRESH_ITEM 20012</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span><span class="preprocessor">#define myID_TAGS 20020</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span>
<a name="l00250"></a><a class="code" href="struct_title_col.html">00250</a> <span class="keyword">struct </span><a class="code" href="struct_title_col.html">TitleCol</a> : <a class="code" href="struct_column_handler.html">ColumnHandler</a>
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252   wxString getText(<a class="code" href="struct_game_info.html">GameInfo</a> &amp;e)
<a name="l00253"></a>00253   {
<a name="l00254"></a>00254     <span class="keywordflow">return</span> e.name;
<a name="l00255"></a>00255   }
<a name="l00256"></a>00256 };
<a name="l00257"></a>00257 
<a name="l00258"></a><a class="code" href="struct_add_date_col.html">00258</a> <span class="keyword">struct </span><a class="code" href="struct_add_date_col.html">AddDateCol</a> : <a class="code" href="struct_column_handler.html">ColumnHandler</a>
<a name="l00259"></a>00259 {
<a name="l00260"></a>00260   wxString getText(<a class="code" href="struct_game_info.html">GameInfo</a> &amp;e)
<a name="l00261"></a>00261   {
<a name="l00262"></a>00262     <span class="keywordflow">return</span> e.timeString;
<a name="l00263"></a>00263   }
<a name="l00264"></a>00264 };
<a name="l00265"></a>00265 
<a name="l00266"></a><a class="code" href="struct_type_col.html">00266</a> <span class="keyword">struct </span><a class="code" href="struct_type_col.html">TypeCol</a> : <a class="code" href="struct_column_handler.html">ColumnHandler</a>
<a name="l00267"></a>00267 {
<a name="l00268"></a>00268   wxString getText(<a class="code" href="struct_game_info.html">GameInfo</a> &amp;e)
<a name="l00269"></a>00269   {
<a name="l00270"></a>00270     <span class="keywordflow">if</span>(e.entry.tigInfo.isDemo)
<a name="l00271"></a>00271       <span class="keywordflow">return</span> wxT(<span class="stringliteral">&quot;demo&quot;</span>);
<a name="l00272"></a>00272     <span class="keywordflow">return</span> wxT(<span class="stringliteral">&quot;freeware&quot;</span>);
<a name="l00273"></a>00273   }
<a name="l00274"></a>00274 };
<a name="l00275"></a>00275 
<a name="l00276"></a><a class="code" href="struct_rating_col.html">00276</a> <span class="keyword">struct </span><a class="code" href="struct_rating_col.html">RatingCol</a> : <a class="code" href="struct_column_handler.html">ColumnHandler</a>
<a name="l00277"></a>00277 {
<a name="l00278"></a>00278   wxString getText(<a class="code" href="struct_game_info.html">GameInfo</a> &amp;e)
<a name="l00279"></a>00279   {
<a name="l00280"></a>00280     <span class="keywordflow">return</span> e.rating;
<a name="l00281"></a>00281   }
<a name="l00282"></a>00282 };
<a name="l00283"></a>00283 
<a name="l00284"></a><a class="code" href="struct_downloads_col.html">00284</a> <span class="keyword">struct </span><a class="code" href="struct_downloads_col.html">DownloadsCol</a> : <a class="code" href="struct_column_handler.html">ColumnHandler</a>
<a name="l00285"></a>00285 {
<a name="l00286"></a>00286   wxString getText(<a class="code" href="struct_game_info.html">GameInfo</a> &amp;e)
<a name="l00287"></a>00287   {
<a name="l00288"></a>00288     <span class="keywordflow">return</span> e.dlCount;
<a name="l00289"></a>00289   }
<a name="l00290"></a>00290 };
<a name="l00291"></a>00291 
<a name="l00292"></a><a class="code" href="struct_price_col.html">00292</a> <span class="keyword">struct </span><a class="code" href="struct_price_col.html">PriceCol</a> : <a class="code" href="struct_column_handler.html">ColumnHandler</a>
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294   wxString getText(<a class="code" href="struct_game_info.html">GameInfo</a> &amp;e)
<a name="l00295"></a>00295   {
<a name="l00296"></a>00296     <span class="keywordflow">return</span> e.price;
<a name="l00297"></a>00297   }
<a name="l00298"></a>00298 };
<a name="l00299"></a>00299 
<a name="l00300"></a><a class="code" href="struct_status_col.html">00300</a> <span class="keyword">struct </span><a class="code" href="struct_status_col.html">StatusCol</a> : <a class="code" href="struct_column_handler.html">ColumnHandler</a>
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302   wxString textNotInst, textReady;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304   <a class="code" href="struct_status_col.html">StatusCol</a>()
<a name="l00305"></a>00305   {
<a name="l00306"></a>00306     textNotInst = wxT(<span class="stringliteral">&quot;Not installed&quot;</span>);
<a name="l00307"></a>00307     textReady = wxT(<span class="stringliteral">&quot;Ready to play&quot;</span>);
<a name="l00308"></a>00308   }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   wxString getText(<a class="code" href="struct_game_info.html">GameInfo</a> &amp;g)
<a name="l00311"></a>00311   {
<a name="l00312"></a>00312     <span class="keywordflow">if</span>(g.isNone())
<a name="l00313"></a>00313       <span class="keywordflow">return</span> textNotInst;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="keywordflow">if</span>(g.isInstalled())
<a name="l00316"></a>00316       <span class="keywordflow">return</span> textReady;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="keywordflow">if</span>(g.isWorking())
<a name="l00319"></a>00319       <span class="keywordflow">return</span> g.getStatus();
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     assert(0);
<a name="l00322"></a>00322   }
<a name="l00323"></a>00323 };
<a name="l00324"></a>00324 
<a name="l00325"></a><a class="code" href="struct_sort_options.html">00325</a> <span class="keyword">struct </span><a class="code" href="struct_sort_options.html">SortOptions</a>
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327   <span class="keyword">virtual</span> <span class="keywordtype">void</span> addSortOptions(wxWindow *parent, wxBoxSizer *pane) <span class="keyword">const</span> = 0;
<a name="l00328"></a>00328 };
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="comment">// Callback to update all lists when an object moves. I don&#39;t like</span>
<a name="l00331"></a>00331 <span class="comment">// this AT ALL, and it should be done using wx events instead, but fix</span>
<a name="l00332"></a>00332 <span class="comment">// it later.</span>
<a name="l00333"></a><a class="code" href="struct_status_notify.html">00333</a> <span class="keyword">struct </span><a class="code" href="struct_status_notify.html">StatusNotify</a>
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335   <span class="keyword">virtual</span> <span class="keywordtype">void</span> onDataChanged() = 0;
<a name="l00336"></a>00336   <span class="keyword">virtual</span> <span class="keywordtype">void</span> switchToInstalled() = 0;
<a name="l00337"></a>00337 };
<a name="l00338"></a>00338 
<a name="l00339"></a><a class="code" href="struct_list_tab.html">00339</a> <span class="keyword">struct </span><a class="code" href="struct_list_tab.html">ListTab</a> : <a class="code" href="struct_tab_base.html">TabBase</a>, <a class="code" href="struct_screenshot_callback.html">ScreenshotCallback</a>
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341   wxButton *b1, *b2, *supportButton;
<a name="l00342"></a>00342   <a class="code" href="class_my_list.html">MyList</a> *list;
<a name="l00343"></a>00343   wxTextCtrl *textView;
<a name="l00344"></a>00344   <a class="code" href="struct_image_viewer.html">ImageViewer</a> *screenshot, *ad_img;
<a name="l00345"></a>00345   <span class="keywordtype">int</span> select;
<a name="l00346"></a>00346   time_t last_launch;
<a name="l00347"></a>00347   <a class="code" href="class_list_keeper.html">ListKeeper</a> lister;
<a name="l00348"></a>00348   wxListBox *tags;
<a name="l00349"></a>00349   wxString tabName;
<a name="l00350"></a>00350   <a class="code" href="struct_status_notify.html">StatusNotify</a> *stat;
<a name="l00351"></a>00351   wxChoice *rateBox;
<a name="l00352"></a>00352   wxStaticText *rateText;
<a name="l00353"></a>00353   wxString rateString[7];
<a name="l00354"></a>00354 
<a name="l00355"></a>00355   std::vector&lt;TagSorter::Entry&gt; taglist;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357   <a class="code" href="struct_list_tab.html">ListTab</a>(wxNotebook *parent, <span class="keyword">const</span> wxString &amp;name, <span class="keywordtype">int</span> listType,
<a name="l00358"></a>00358           <a class="code" href="struct_status_notify.html">StatusNotify</a> *s, <span class="keyword">const</span> <a class="code" href="struct_sort_options.html">SortOptions</a> *sop = NULL)
<a name="l00359"></a>00359     : <a class="code" href="struct_tab_base.html">TabBase</a>(parent), select(-1), last_launch(0),
<a name="l00360"></a>00360       lister(data, listType), tabName(name), stat(s)
<a name="l00361"></a>00361   {
<a name="l00362"></a>00362     list = <span class="keyword">new</span> <a class="code" href="class_my_list.html">MyList</a>(<span class="keyword">this</span>, myID_LIST, lister);
<a name="l00363"></a>00363 
<a name="l00364"></a>00364     wxBoxSizer *searchBox = <span class="keyword">new</span> wxBoxSizer(wxHORIZONTAL);
<a name="l00365"></a>00365     searchBox-&gt;Add(<span class="keyword">new</span> wxStaticText(<span class="keyword">this</span>, wxID_ANY, wxT(<span class="stringliteral">&quot;Search:&quot;</span>)), 0);
<a name="l00366"></a>00366     searchBox-&gt;Add(<span class="keyword">new</span> wxTextCtrl(<span class="keyword">this</span>, myID_SEARCH_BOX, wxT(<span class="stringliteral">&quot;&quot;</span>), wxDefaultPosition,
<a name="l00367"></a>00367                                   wxSize(260,22)),1, wxGROW);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     <span class="comment">/*</span>
<a name="l00370"></a>00370 <span class="comment">    wxBoxSizer *sortBox = new wxBoxSizer(wxHORIZONTAL);</span>
<a name="l00371"></a>00371 <span class="comment">    if(sop)</span>
<a name="l00372"></a>00372 <span class="comment">      sop-&gt;addSortOptions(this, sortBox);</span>
<a name="l00373"></a>00373 <span class="comment">    */</span>
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     wxBoxSizer *centerPane = <span class="keyword">new</span> wxBoxSizer(wxVERTICAL);
<a name="l00376"></a>00376     centerPane-&gt;Add(list, 1, wxGROW | wxRIGHT | wxBOTTOM, 10);
<a name="l00377"></a>00377     centerPane-&gt;Add(searchBox, 0, wxBOTTOM, 2);
<a name="l00378"></a>00378     <span class="comment">/*</span>
<a name="l00379"></a>00379 <span class="comment">    centerPane-&gt;Add(sortBox, 0);</span>
<a name="l00380"></a>00380 <span class="comment">    centerPane-&gt;Add(new wxCheckBox(this, myID_SORT_REVERSE, wxT(&quot;Reverse order&quot;)),</span>
<a name="l00381"></a>00381 <span class="comment">                  0);</span>
<a name="l00382"></a>00382 <span class="comment">    */</span>
<a name="l00383"></a>00383     centerPane-&gt;Add(<span class="keyword">new</span> wxStaticText(<span class="keyword">this</span>, wxID_ANY, wxString(wxT(<span class="stringliteral">&quot;Mouse: double-click to &quot;</span>)) +
<a name="l00384"></a>00384                                    ((listType == ListKeeper::SL_INSTALL)?
<a name="l00385"></a>00385                                     wxT(<span class="stringliteral">&quot;play&quot;</span>):wxT(<span class="stringliteral">&quot;install&quot;</span>)) +
<a name="l00386"></a>00386                                    wxT(<span class="stringliteral">&quot;\nKeyboard: arrow keys + enter, delete&quot;</span>)),
<a name="l00387"></a>00387                   0, wxLEFT | wxBOTTOM, 4);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     textView = <span class="keyword">new</span> wxTextCtrl
<a name="l00390"></a>00390       (<span class="keyword">this</span>, myID_TEXTVIEW, wxT(<span class="stringliteral">&quot;&quot;</span>), wxDefaultPosition, wxDefaultSize,
<a name="l00391"></a>00391        wxBORDER_NONE | wxTE_MULTILINE | wxTE_READONLY | wxTE_AUTO_URL | wxTE_RICH);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     screenshot = <span class="keyword">new</span> <a class="code" href="struct_image_viewer.html">ImageViewer</a>(<span class="keyword">this</span>, myID_SCREENSHOT, wxDefaultPosition,
<a name="l00394"></a>00394                                  wxSize(300,260));
<a name="l00395"></a>00395 
<a name="l00396"></a>00396     b1 = <span class="keyword">new</span> wxButton(<span class="keyword">this</span>, myID_BUTTON1, wxT(<span class="stringliteral">&quot;No action&quot;</span>));
<a name="l00397"></a>00397     b2 = <span class="keyword">new</span> wxButton(<span class="keyword">this</span>, myID_BUTTON2, wxT(<span class="stringliteral">&quot;No action&quot;</span>));
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     supportButton = <span class="keyword">new</span> wxButton(<span class="keyword">this</span>, myID_SUPPORT, wxT(<span class="stringliteral">&quot;Support Game (donate)&quot;</span>));
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     wxBoxSizer *buttonBar = <span class="keyword">new</span> wxBoxSizer(wxHORIZONTAL);
<a name="l00402"></a>00402     buttonBar-&gt;Add(b1, 0, wxTOP | wxBOTTOM | wxRIGHT, 3);
<a name="l00403"></a>00403     buttonBar-&gt;Add(b2, 0, wxTOP | wxBOTTOM | wxRIGHT, 3);
<a name="l00404"></a>00404     buttonBar-&gt;Add(<span class="keyword">new</span> wxButton(<span class="keyword">this</span>, myID_GAMEPAGE, wxT(<span class="stringliteral">&quot;Game Website&quot;</span>)),
<a name="l00405"></a>00405                    0, wxTOP | wxBOTTOM, 3);
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     wxBoxSizer *buttonHolder = <span class="keyword">new</span> wxBoxSizer(wxVERTICAL);
<a name="l00408"></a>00408     buttonHolder-&gt;Add(supportButton, 0, wxALIGN_RIGHT);
<a name="l00409"></a>00409     buttonHolder-&gt;Add(buttonBar, 0);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     wxString choices[7];
<a name="l00412"></a>00412     choices[0] = wxT(<span class="stringliteral">&quot;Rate this game&quot;</span>);
<a name="l00413"></a>00413     choices[1] = wxT(<span class="stringliteral">&quot;5: Awesome!&quot;</span>);
<a name="l00414"></a>00414     choices[2] = wxT(<span class="stringliteral">&quot;4: Very Good&quot;</span>);
<a name="l00415"></a>00415     choices[3] = wxT(<span class="stringliteral">&quot;3: It&#39;s OK&quot;</span>);
<a name="l00416"></a>00416     choices[4] = wxT(<span class="stringliteral">&quot;2: Meh&quot;</span>);
<a name="l00417"></a>00417     choices[5] = wxT(<span class="stringliteral">&quot;1: Very Bad&quot;</span>);
<a name="l00418"></a>00418     choices[6] = wxT(<span class="stringliteral">&quot;0: Unplayable&quot;</span>);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420     rateString[0] = wxT(<span class="stringliteral">&quot;Your rating: not rated&quot;</span>);
<a name="l00421"></a>00421     rateString[1] = wxT(<span class="stringliteral">&quot;Your rating: 0 (unplayable)&quot;</span>);
<a name="l00422"></a>00422     rateString[2] = wxT(<span class="stringliteral">&quot;Your rating: 1 (very bad)&quot;</span>);
<a name="l00423"></a>00423     rateString[3] = wxT(<span class="stringliteral">&quot;Your rating: 2 (meh)&quot;</span>);
<a name="l00424"></a>00424     rateString[4] = wxT(<span class="stringliteral">&quot;Your rating: 3 (ok)&quot;</span>);
<a name="l00425"></a>00425     rateString[5] = wxT(<span class="stringliteral">&quot;Your rating: 4 (very good)&quot;</span>);
<a name="l00426"></a>00426     rateString[6] = wxT(<span class="stringliteral">&quot;Your rating: 5 (awesome)&quot;</span>);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     rateBox = <span class="keyword">new</span> wxChoice(<span class="keyword">this</span>, myID_RATE, wxDefaultPosition, wxDefaultSize,
<a name="l00429"></a>00429                            7, choices);
<a name="l00430"></a>00430     rateText = <span class="keyword">new</span> wxStaticText(<span class="keyword">this</span>, wxID_ANY, wxT(<span class="stringliteral">&quot;&quot;</span>));
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     wxBoxSizer *rateBar = <span class="keyword">new</span> wxBoxSizer(wxHORIZONTAL);
<a name="l00433"></a>00433     rateBar-&gt;Add(rateBox, 0, wxRIGHT, 5);
<a name="l00434"></a>00434     rateBar-&gt;Add(rateText, 0, wxTOP | wxLEFT, 6);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     wxBoxSizer *rightPane = <span class="keyword">new</span> wxBoxSizer(wxVERTICAL);
<a name="l00437"></a>00437     rightPane-&gt;Add(screenshot, 0, wxTOP, 5);
<a name="l00438"></a>00438     rightPane-&gt;Add(rateBar);
<a name="l00439"></a>00439     rightPane-&gt;Add(textView, 1, wxGROW | wxTOP | wxRIGHT | wxBOTTOM, 7);
<a name="l00440"></a>00440     rightPane-&gt;Add(buttonHolder);
<a name="l00441"></a>00441     <span class="comment">/*</span>
<a name="l00442"></a>00442 <span class="comment">    rightPane-&gt;Add(supportButton, 0, wxALIGN_RIGHT);</span>
<a name="l00443"></a>00443 <span class="comment">    rightPane-&gt;Add(buttonBar, 0);</span>
<a name="l00444"></a>00444 <span class="comment">    */</span>
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     tags = <span class="keyword">new</span> wxListBox(<span class="keyword">this</span>, myID_TAGS);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     wxBoxSizer *leftPane = <span class="keyword">new</span> wxBoxSizer(wxVERTICAL);
<a name="l00449"></a>00449     leftPane-&gt;Add(tags, 1, wxGROW);
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <span class="comment">/*</span>
<a name="l00452"></a>00452 <span class="comment">    ad_img = new ImageViewer(this, myID_SCREENSHOT, wxDefaultPosition,</span>
<a name="l00453"></a>00453 <span class="comment">                             wxSize(100,160));</span>
<a name="l00454"></a>00454 <span class="comment">    leftPane-&gt;Add(new wxStaticText(this, wxID_ANY, wxT(&quot;Sponsor:&quot;)), 0);</span>
<a name="l00455"></a>00455 <span class="comment">    leftPane-&gt;Add(ad_img, 0);</span>
<a name="l00456"></a>00456 <span class="comment">    */</span>
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     createTagList();
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     wxBoxSizer *panes = <span class="keyword">new</span> wxBoxSizer(wxHORIZONTAL);
<a name="l00461"></a>00461     panes-&gt;Add(leftPane, 30, wxGROW);
<a name="l00462"></a>00462     panes-&gt;Add(centerPane, 100, wxGROW);
<a name="l00463"></a>00463     panes-&gt;Add(rightPane, 60, wxGROW);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     SetSizer(panes);
<a name="l00466"></a>00466 
<a name="l00467"></a>00467     Connect(myID_TEXTVIEW, wxEVT_COMMAND_TEXT_URL,
<a name="l00468"></a>00468             wxTextUrlEventHandler(ListTab::onUrlEvent));
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     Connect(myID_TAGS, wxEVT_COMMAND_LISTBOX_SELECTED,
<a name="l00471"></a>00471             wxCommandEventHandler(ListTab::onTagSelect));
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     Connect(myID_GAMEPAGE, wxEVT_COMMAND_BUTTON_CLICKED,
<a name="l00474"></a>00474             wxCommandEventHandler(ListTab::onGamePage));
<a name="l00475"></a>00475 
<a name="l00476"></a>00476     Connect(myID_SUPPORT, wxEVT_COMMAND_BUTTON_CLICKED,
<a name="l00477"></a>00477             wxCommandEventHandler(ListTab::onGamePage));
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     Connect(myID_BUTTON1, wxEVT_COMMAND_BUTTON_CLICKED,
<a name="l00480"></a>00480             wxCommandEventHandler(ListTab::onButton));
<a name="l00481"></a>00481     Connect(myID_BUTTON2, wxEVT_COMMAND_BUTTON_CLICKED,
<a name="l00482"></a>00482             wxCommandEventHandler(ListTab::onButton));
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     Connect(myID_LIST, wxEVT_COMMAND_LIST_ITEM_SELECTED,
<a name="l00485"></a>00485             wxListEventHandler(ListTab::onListSelect));
<a name="l00486"></a>00486     Connect(myID_LIST, wxEVT_COMMAND_LIST_ITEM_DESELECTED,
<a name="l00487"></a>00487             wxListEventHandler(ListTab::onListDeselect));
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     Connect(myID_LIST, wxEVT_COMMAND_LIST_ITEM_RIGHT_CLICK,
<a name="l00490"></a>00490             wxListEventHandler(ListTab::onListRightClick));
<a name="l00491"></a>00491     Connect(myID_LIST, wxEVT_COMMAND_LIST_ITEM_ACTIVATED,
<a name="l00492"></a>00492             wxListEventHandler(ListTab::onListActivate));
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     Connect(myID_RATE, wxEVT_COMMAND_CHOICE_SELECTED,
<a name="l00495"></a>00495             wxCommandEventHandler(ListTab::onRating));
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     Connect(myID_SORT_TITLE, wxEVT_COMMAND_RADIOBUTTON_SELECTED,
<a name="l00498"></a>00498             wxCommandEventHandler(ListTab::onSortChange));
<a name="l00499"></a>00499     Connect(myID_SORT_DATE, wxEVT_COMMAND_RADIOBUTTON_SELECTED,
<a name="l00500"></a>00500             wxCommandEventHandler(ListTab::onSortChange));
<a name="l00501"></a>00501     Connect(myID_SORT_REVERSE, wxEVT_COMMAND_CHECKBOX_CLICKED,
<a name="l00502"></a>00502             wxCommandEventHandler(ListTab::onSortChange));
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     Connect(myID_SEARCH_BOX, wxEVT_COMMAND_TEXT_UPDATED,
<a name="l00505"></a>00505             wxCommandEventHandler(ListTab::onSearch));
<a name="l00506"></a>00506 
<a name="l00507"></a>00507     list-&gt;update();
<a name="l00508"></a>00508     takeFocus();
<a name="l00509"></a>00509   }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511   <span class="keywordtype">void</span> createTagList()
<a name="l00512"></a>00512   {
<a name="l00513"></a>00513     <span class="comment">// Set up the tag list</span>
<a name="l00514"></a>00514     <span class="keyword">const</span> vector&lt;int&gt; &amp;base = lister.getBaseList();
<a name="l00515"></a>00515     tagSorter.makeTagList(base, taglist);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517     <span class="comment">// Create and set up the wxString version of the tag list</span>
<a name="l00518"></a>00518     std::vector&lt;wxString&gt; labels;
<a name="l00519"></a>00519     labels.resize(taglist.size()+1);
<a name="l00520"></a>00520     labels[0] = wxString::Format(wxT(<span class="stringliteral">&quot;All (%d)&quot;</span>), base.size());
<a name="l00521"></a>00521     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;taglist.size(); i++)
<a name="l00522"></a>00522       {
<a name="l00523"></a>00523         <a class="code" href="struct_tag_sorter_1_1_entry.html">TagSorter::Entry</a> &amp;e = taglist[i];
<a name="l00524"></a>00524         wxString &amp;str = labels[i+1];
<a name="l00525"></a>00525 
<a name="l00526"></a>00526         str = wxString(e.tag.c_str(), wxConvUTF8);
<a name="l00527"></a>00527         str += wxString::Format(wxT(<span class="stringliteral">&quot; (%d)&quot;</span>), e.games.size());
<a name="l00528"></a>00528       }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="comment">// Clear tag control</span>
<a name="l00531"></a>00531     tags-&gt;Clear();
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <span class="comment">// Add new strings to it</span>
<a name="l00534"></a>00534     tags-&gt;InsertItems(labels.size(), &amp;labels[0], 0);
<a name="l00535"></a>00535   }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537   <span class="comment">// Respond to clickable URLs in the game description</span>
<a name="l00538"></a>00538   <span class="keywordtype">void</span> onUrlEvent(wxTextUrlEvent &amp;event)
<a name="l00539"></a>00539   {
<a name="l00540"></a>00540     <span class="keywordflow">if</span>(!event.GetMouseEvent().ButtonDown(wxMOUSE_BTN_LEFT))
<a name="l00541"></a>00541       <span class="keywordflow">return</span>;
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     wxString url = textView-&gt;GetRange(event.GetURLStart(), <span class="keyword">event</span>.GetURLEnd());
<a name="l00544"></a>00544     wxLaunchDefaultBrowser(url);
<a name="l00545"></a>00545   }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547   <span class="keywordtype">void</span> onRating(wxCommandEvent &amp;event)
<a name="l00548"></a>00548   {
<a name="l00549"></a>00549     <span class="keywordtype">int</span> rate = <span class="keyword">event</span>.GetInt();
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <span class="comment">// The first choice is just &quot;Rate this game&quot;</span>
<a name="l00552"></a>00552     <span class="keywordflow">if</span>(rate == 0) <span class="keywordflow">return</span>;
<a name="l00553"></a>00553     rate = 6 - rate; <span class="comment">// The rest are in reverse order</span>
<a name="l00554"></a>00554     assert(rate &gt;= 0 &amp;&amp; rate &lt;= 5);
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     <span class="keywordflow">if</span>(select &lt; 0 || select &gt;= lister.size())
<a name="l00557"></a>00557       <span class="keywordflow">return</span>;
<a name="l00558"></a>00558 
<a name="l00559"></a>00559     GameInfo::conv(lister.get(select)).rateGame(rate);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     updateGameInfo();
<a name="l00562"></a>00562   }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564   <span class="keywordtype">void</span> onTagSelect(wxCommandEvent &amp;event)
<a name="l00565"></a>00565   {
<a name="l00566"></a>00566     <span class="keywordtype">int</span> sel = <span class="keyword">event</span>.GetSelection();
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <span class="comment">// Deselections are equivalent to selecting &quot;All&quot;</span>
<a name="l00569"></a>00569     <span class="keywordflow">if</span>(sel &lt;= 0 || !event.IsSelection() || sel &gt; taglist.size())
<a name="l00570"></a>00570       lister.clearSubSelection();
<a name="l00571"></a>00571     <span class="keywordflow">else</span>
<a name="l00572"></a>00572       {
<a name="l00573"></a>00573         sel--;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575         assert(sel &gt;= 0 &amp;&amp; sel &lt; taglist.size());
<a name="l00576"></a>00576         <a class="code" href="struct_tag_sorter_1_1_entry.html">TagSorter::Entry</a> &amp;e = taglist[sel];
<a name="l00577"></a>00577         lister.setSubSelection(e.games);
<a name="l00578"></a>00578       }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     listHasChanged();
<a name="l00581"></a>00581   }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583   <span class="keywordtype">void</span> insertMe()
<a name="l00584"></a>00584   {
<a name="l00585"></a>00585     TabBase::insertMe();
<a name="l00586"></a>00586     wxString name = tabName + wxString::Format(wxT(<span class="stringliteral">&quot; (%d)&quot;</span>), lister.baseSize());
<a name="l00587"></a>00587     book-&gt;SetPageText(tabNum, name);
<a name="l00588"></a>00588   }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590   <span class="keywordtype">void</span> takeFocus()
<a name="l00591"></a>00591   {
<a name="l00592"></a>00592     list-&gt;SetFocus();
<a name="l00593"></a>00593     updateSelection();
<a name="l00594"></a>00594   }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596   <span class="comment">// Called on &quot;soft&quot; list changes, such as search queries. If</span>
<a name="l00597"></a>00597   <span class="comment">// stay=true, try to stay at the same position.</span>
<a name="l00598"></a>00598   <span class="keywordtype">void</span> listHasChanged(<span class="keywordtype">bool</span> stay=<span class="keyword">false</span>)
<a name="l00599"></a>00599   {
<a name="l00600"></a>00600     list-&gt;update(stay);
<a name="l00601"></a>00601     updateSelection();
<a name="l00602"></a>00602   }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604   <span class="keywordtype">void</span> updateGameInfo()
<a name="l00605"></a>00605   {
<a name="l00606"></a>00606     screenshot-&gt;clear();
<a name="l00607"></a>00607     <span class="keywordflow">if</span>(select &lt; 0 || select &gt;= lister.size())
<a name="l00608"></a>00608       {
<a name="l00609"></a>00609         textView-&gt;Clear();
<a name="l00610"></a>00610         rateText-&gt;SetLabel(rateString[0]);
<a name="l00611"></a>00611         rateBox-&gt;Disable();
<a name="l00612"></a>00612         <span class="keywordflow">return</span>;
<a name="l00613"></a>00613       }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <a class="code" href="struct_data_list_1_1_entry.html">DataList::Entry</a> &amp;e = lister.get(select);
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     <span class="comment">// Update the text view</span>
<a name="l00618"></a>00618     textView-&gt;ChangeValue(wxString(e.tigInfo.desc.c_str(), wxConvUTF8));
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <a class="code" href="struct_game_info.html">GameInfo</a> &amp;g = GameInfo::conv(e);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     <span class="comment">// Request a screenshot update</span>
<a name="l00623"></a>00623     g.requestShot(<span class="keyword">this</span>);
<a name="l00624"></a>00624 
<a name="l00625"></a>00625     <span class="comment">// Revert rating box</span>
<a name="l00626"></a>00626     rateBox-&gt;SetSelection(0);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <span class="comment">// Have we already rated this game?</span>
<a name="l00629"></a>00629     <span class="keywordtype">int</span> rating = g.myRating();
<a name="l00630"></a>00630 
<a name="l00631"></a>00631     <span class="keywordflow">if</span>(rating == -1)
<a name="l00632"></a>00632       {
<a name="l00633"></a>00633         <span class="comment">// No, enable rating dropdown</span>
<a name="l00634"></a>00634         rateBox-&gt;Enable();
<a name="l00635"></a>00635         rateText-&gt;SetLabel(rateString[0]);
<a name="l00636"></a>00636       }
<a name="l00637"></a>00637     <span class="keywordflow">else</span>
<a name="l00638"></a>00638       {
<a name="l00639"></a>00639         <span class="comment">// Yup. Update textbox to reflect our previous rating.</span>
<a name="l00640"></a>00640         rateBox-&gt;Disable();
<a name="l00641"></a>00641         assert(rating &gt;= 0 &amp;&amp; rating &lt;= 5);
<a name="l00642"></a>00642         rateText-&gt;SetLabel(rateString[rating+1]);
<a name="l00643"></a>00643       }
<a name="l00644"></a>00644   }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646   <span class="comment">// Called whenever a screenshot is ready</span>
<a name="l00647"></a>00647   <span class="keywordtype">void</span> shotIsReady(<span class="keyword">const</span> std::string &amp;idname, <span class="keyword">const</span> wxImage &amp;shot)
<a name="l00648"></a>00648   {
<a name="l00649"></a>00649     <span class="comment">// Check if the shot belongs to the selected game</span>
<a name="l00650"></a>00650     <span class="keywordflow">if</span>(select &lt; 0 || select &gt;= lister.size())
<a name="l00651"></a>00651       <span class="keywordflow">return</span>;
<a name="l00652"></a>00652     <span class="keywordflow">if</span>(GameInfo::conv(lister.get(select)).entry.idname != idname)
<a name="l00653"></a>00653       <span class="keywordflow">return</span>;
<a name="l00654"></a>00654 
<a name="l00655"></a>00655     <span class="comment">// We have a match. Set the screenshot.</span>
<a name="l00656"></a>00656     screenshot-&gt;loadImage(shot);
<a name="l00657"></a>00657   }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659   <span class="comment">// Called whenever there is a chance that a new game has been</span>
<a name="l00660"></a>00660   <span class="comment">// selected. This updates the available action buttons as well as</span>
<a name="l00661"></a>00661   <span class="comment">// the displayed game info to match the current selection.</span>
<a name="l00662"></a>00662   <span class="keywordtype">void</span> updateSelection()
<a name="l00663"></a>00663   {
<a name="l00664"></a>00664     fixButtons();
<a name="l00665"></a>00665     updateGameInfo();
<a name="l00666"></a>00666   }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668   <span class="comment">// Fix buttons for the current selected item (if any)</span>
<a name="l00669"></a>00669   <span class="keywordtype">void</span> fixButtons()
<a name="l00670"></a>00670   {
<a name="l00671"></a>00671     <span class="keywordflow">if</span>(select &lt; 0 || select &gt;= lister.size())
<a name="l00672"></a>00672       {
<a name="l00673"></a>00673         b1-&gt;Disable();
<a name="l00674"></a>00674         b2-&gt;Disable();
<a name="l00675"></a>00675         supportButton-&gt;Disable();
<a name="l00676"></a>00676         b1-&gt;SetLabel(wxT(<span class="stringliteral">&quot;No action&quot;</span>));
<a name="l00677"></a>00677         b2-&gt;SetLabel(wxT(<span class="stringliteral">&quot;No action&quot;</span>));
<a name="l00678"></a>00678         <span class="keywordflow">return</span>;
<a name="l00679"></a>00679       }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <a class="code" href="struct_data_list_1_1_entry.html">DataList::Entry</a> &amp;e = lister.get(select);
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <span class="keywordflow">if</span>(e.tigInfo.isDemo)
<a name="l00684"></a>00684       {
<a name="l00685"></a>00685         supportButton-&gt;Enable();
<a name="l00686"></a>00686         supportButton-&gt;SetLabel(wxT(<span class="stringliteral">&quot;Buy Game (external link)&quot;</span>));
<a name="l00687"></a>00687       }
<a name="l00688"></a>00688     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(e.tigInfo.hasPaypal)
<a name="l00689"></a>00689       {
<a name="l00690"></a>00690         supportButton-&gt;Enable();
<a name="l00691"></a>00691         supportButton-&gt;SetLabel(wxT(<span class="stringliteral">&quot;Support Game (donate)&quot;</span>));
<a name="l00692"></a>00692       }
<a name="l00693"></a>00693     <span class="keywordflow">else</span>
<a name="l00694"></a>00694       supportButton-&gt;Disable();
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     b1-&gt;Enable();
<a name="l00697"></a>00697     b2-&gt;Enable();
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     <a class="code" href="struct_game_info.html">GameInfo</a> &amp;g = GameInfo::conv(e);
<a name="l00700"></a>00700     <span class="keywordflow">if</span>(g.isNone())
<a name="l00701"></a>00701       {
<a name="l00702"></a>00702         b1-&gt;SetLabel(wxT(<span class="stringliteral">&quot;Install&quot;</span>));
<a name="l00703"></a>00703         b2-&gt;SetLabel(wxT(<span class="stringliteral">&quot;No action&quot;</span>));
<a name="l00704"></a>00704         b2-&gt;Disable();
<a name="l00705"></a>00705       }
<a name="l00706"></a>00706     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(g.isWorking())
<a name="l00707"></a>00707       {
<a name="l00708"></a>00708         b1-&gt;SetLabel(wxT(<span class="stringliteral">&quot;Pause&quot;</span>));
<a name="l00709"></a>00709         b2-&gt;SetLabel(wxT(<span class="stringliteral">&quot;Abort&quot;</span>));
<a name="l00710"></a>00710 
<a name="l00711"></a>00711         <span class="comment">// Pausing is not implemented yet</span>
<a name="l00712"></a>00712         b1-&gt;Disable();
<a name="l00713"></a>00713       }
<a name="l00714"></a>00714     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(g.isInstalled())
<a name="l00715"></a>00715       {
<a name="l00716"></a>00716         b1-&gt;SetLabel(wxT(<span class="stringliteral">&quot;Play Now&quot;</span>));
<a name="l00717"></a>00717         b2-&gt;SetLabel(wxT(<span class="stringliteral">&quot;Uninstall&quot;</span>));
<a name="l00718"></a>00718       }
<a name="l00719"></a>00719   }
<a name="l00720"></a>00720 
<a name="l00721"></a>00721   <span class="keywordtype">void</span> onSearch(wxCommandEvent &amp;event)
<a name="l00722"></a>00722   {
<a name="l00723"></a>00723     <span class="keywordtype">string</span> src = string(event.GetString().mb_str());
<a name="l00724"></a>00724     lister.setSearch(src);
<a name="l00725"></a>00725     listHasChanged();
<a name="l00726"></a>00726   }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   <span class="comment">// I&#39;m short on change, can you help a fella out?</span>
<a name="l00729"></a>00729   <span class="keywordtype">void</span> onSortChange(wxCommandEvent &amp;event)
<a name="l00730"></a>00730   {
<a name="l00731"></a>00731     <span class="keywordtype">int</span> <span class="keywordtype">id</span> = <span class="keyword">event</span>.GetId();
<a name="l00732"></a>00732 
<a name="l00733"></a>00733     <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == myID_SORT_REVERSE)
<a name="l00734"></a>00734       lister.setReverse(event.IsChecked());
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == myID_SORT_TITLE)
<a name="l00737"></a>00737       lister.sortTitle();
<a name="l00738"></a>00738 
<a name="l00739"></a>00739     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == myID_SORT_DATE)
<a name="l00740"></a>00740       lister.sortDate();
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == myID_SORT_RATING)
<a name="l00743"></a>00743       lister.sortRating();
<a name="l00744"></a>00744 
<a name="l00745"></a>00745     <span class="keywordflow">else</span> assert(0);
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     listHasChanged();
<a name="l00748"></a>00748   }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750   <span class="keywordtype">void</span> updateStatus(<span class="keywordtype">int</span> index)
<a name="l00751"></a>00751   {
<a name="l00752"></a>00752     <a class="code" href="struct_game_info.html">GameInfo</a> &amp;e = GameInfo::conv(lister.get(index));
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     <span class="comment">// If this is the current item, make sure the buttons are set</span>
<a name="l00755"></a>00755     <span class="comment">// correctly.</span>
<a name="l00756"></a>00756     <span class="keywordflow">if</span>(index == select) fixButtons();
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     <span class="keywordflow">try</span>
<a name="l00759"></a>00759       {
<a name="l00760"></a>00760         <span class="keywordtype">int</span> i = e.updateStatus();
<a name="l00761"></a>00761 
<a name="l00762"></a>00762         <span class="keywordflow">if</span>(i&gt;0)
<a name="l00763"></a>00763           statusChanged(<span class="keyword">false</span>, i == 2);
<a name="l00764"></a>00764       }
<a name="l00765"></a>00765     <span class="keywordflow">catch</span>(std::exception &amp;e)
<a name="l00766"></a>00766       {
<a name="l00767"></a>00767         errorBox(wxString(e.what(), wxConvUTF8));
<a name="l00768"></a>00768         statusChanged();
<a name="l00769"></a>00769       }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     <span class="comment">// Update the display</span>
<a name="l00772"></a>00772     list-&gt;RefreshItem(index);
<a name="l00773"></a>00773   }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775   <span class="keywordtype">void</span> startDownload(<span class="keywordtype">int</span> index)
<a name="l00776"></a>00776   {
<a name="l00777"></a>00777     <a class="code" href="struct_data_list_1_1_entry.html">DataList::Entry</a> &amp;e = lister.get(index);
<a name="l00778"></a>00778     <a class="code" href="struct_game_info.html">GameInfo</a> &amp;gi = GameInfo::conv(e);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780     {
<a name="l00781"></a>00781       <span class="comment">// Update the .tig info first</span>
<a name="l00782"></a>00782       <a class="code" href="struct_data_list_1_1_tig_info.html">DataList::TigInfo</a> ti;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784       <span class="comment">// TODO: In future versions, this will be outsourced to a worker</span>
<a name="l00785"></a>00785       <span class="comment">// thread to keep from blocking the app.</span>
<a name="l00786"></a>00786       <span class="keywordflow">if</span>(tig_reader.decodeTigUrl
<a name="l00787"></a>00787          (e.urlname,    <span class="comment">// url-name</span>
<a name="l00788"></a>00788           e.tigurl,     <span class="comment">// url to tigfile</span>
<a name="l00789"></a>00789           ti,           <span class="comment">// where to store result</span>
<a name="l00790"></a>00790           <span class="keyword">false</span>))       <span class="comment">// ONLY use cache if fetch fails</span>
<a name="l00791"></a>00791         {
<a name="l00792"></a>00792           <span class="comment">// Copy new data if the fetch was successful</span>
<a name="l00793"></a>00793           <span class="keywordflow">if</span>(ti.launch != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00794"></a>00794             e.tigInfo = ti;
<a name="l00795"></a>00795         }
<a name="l00796"></a>00796     }
<a name="l00797"></a>00797 
<a name="l00798"></a>00798     gi.startDownload();
<a name="l00799"></a>00799 
<a name="l00800"></a>00800     <span class="comment">// Update this entry now.</span>
<a name="l00801"></a>00801     updateStatus(index);
<a name="l00802"></a>00802 
<a name="l00803"></a>00803     <span class="comment">/* Update lists and moved to the Installed tab.</span>
<a name="l00804"></a>00804 <span class="comment"></span>
<a name="l00805"></a>00805 <span class="comment">       NOTE: this will switch tabs even if download immediately</span>
<a name="l00806"></a>00806 <span class="comment">       fails. This isn&#39;t entirely optimal, but is rare enough that it</span>
<a name="l00807"></a>00807 <span class="comment">       doesn&#39;t matter.</span>
<a name="l00808"></a>00808 <span class="comment">     */</span>
<a name="l00809"></a>00809     statusChanged(<span class="keyword">true</span>);
<a name="l00810"></a>00810   }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812   <span class="comment">/* Called whenever an item switches lists. Set newInst to true if we</span>
<a name="l00813"></a>00813 <span class="comment">     should switch to the &quot;Installed&quot; tab. dataChange is true if the</span>
<a name="l00814"></a>00814 <span class="comment">     lists have changed (meaning we have to update all the display</span>
<a name="l00815"></a>00815 <span class="comment">     lists)</span>
<a name="l00816"></a>00816 <span class="comment">  */</span>
<a name="l00817"></a>00817   <span class="keywordtype">void</span> statusChanged(<span class="keywordtype">bool</span> newInst=<span class="keyword">false</span>, <span class="keywordtype">bool</span> dataChange=<span class="keyword">true</span>)
<a name="l00818"></a>00818   {
<a name="l00819"></a>00819     <span class="comment">// Notify our parent if lists have changed</span>
<a name="l00820"></a>00820     <span class="keywordflow">if</span>(dataChange)
<a name="l00821"></a>00821       stat-&gt;onDataChanged();
<a name="l00822"></a>00822 
<a name="l00823"></a>00823     <span class="comment">// Write install status to config file</span>
<a name="l00824"></a>00824     jinst.write(data);
<a name="l00825"></a>00825 
<a name="l00826"></a>00826     <span class="comment">// Notify parent if newInst was set</span>
<a name="l00827"></a>00827     <span class="keywordflow">if</span>(newInst) stat-&gt;switchToInstalled();
<a name="l00828"></a>00828   }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830   <span class="keywordtype">void</span> doAction(<span class="keywordtype">int</span> index, <span class="keywordtype">int</span> b)
<a name="l00831"></a>00831   {
<a name="l00832"></a>00832     <span class="keywordflow">if</span>(index &lt; 0 || index &gt;= lister.size())
<a name="l00833"></a>00833       <span class="keywordflow">return</span>;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835     <a class="code" href="struct_game_info.html">GameInfo</a> &amp;e = GameInfo::conv(lister.get(index));
<a name="l00836"></a>00836 
<a name="l00837"></a>00837     <span class="comment">// True called as an &#39;activate&#39; command, meaning that the list</span>
<a name="l00838"></a>00838     <span class="comment">// told us the item was activated (it was double clicked or we</span>
<a name="l00839"></a>00839     <span class="comment">// pressed &#39;enter&#39;.)</span>
<a name="l00840"></a>00840     <span class="keywordtype">bool</span> activate = <span class="keyword">false</span>;
<a name="l00841"></a>00841 
<a name="l00842"></a>00842     <span class="keywordflow">if</span>(b == 3)
<a name="l00843"></a>00843       {
<a name="l00844"></a>00844         activate = <span class="keyword">true</span>;
<a name="l00845"></a>00845         b = 1;
<a name="l00846"></a>00846       }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="keywordflow">if</span>(e.isNone() &amp;&amp; b == 1)
<a name="l00849"></a>00849       {
<a name="l00850"></a>00850         startDownload(index);
<a name="l00851"></a>00851         <span class="keywordflow">return</span>;
<a name="l00852"></a>00852       }
<a name="l00853"></a>00853     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(e.isWorking())
<a name="l00854"></a>00854       {
<a name="l00855"></a>00855         <span class="keywordflow">if</span>(b == 2) <span class="comment">// Abort</span>
<a name="l00856"></a>00856           e.abortJob();
<a name="l00857"></a>00857       }
<a name="l00858"></a>00858     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(e.isInstalled())
<a name="l00859"></a>00859       {
<a name="l00860"></a>00860         <span class="comment">// TODO: All these path and file operations could be out-</span>
<a name="l00861"></a>00861         <span class="comment">// sourced to an external module. One &quot;repository&quot; module that</span>
<a name="l00862"></a>00862         <span class="comment">// doesn&#39;t know about the rest of the program is the best bet.</span>
<a name="l00863"></a>00863 
<a name="l00864"></a>00864         <span class="comment">// Construct the install path</span>
<a name="l00865"></a>00865         boost::filesystem::path dir = <span class="stringliteral">&quot;data&quot;</span>;
<a name="l00866"></a>00866         dir /= e.entry.idname;
<a name="l00867"></a>00867         dir = <span class="keyword">get</span>.getPath(dir.string());
<a name="l00868"></a>00868 
<a name="l00869"></a>00869         <span class="keywordflow">if</span>(b == 1)
<a name="l00870"></a>00870           {
<a name="l00871"></a>00871             <span class="comment">// Button1 == Launching</span>
<a name="l00872"></a>00872 
<a name="l00873"></a>00873             <span class="comment">// Check if we double-tapped</span>
<a name="l00874"></a>00874             time_t now = time(0);
<a name="l00875"></a>00875 
<a name="l00876"></a>00876             <span class="comment">// Did we just start something?</span>
<a name="l00877"></a>00877             <span class="keywordflow">if</span>(difftime(now,last_launch) &lt;= 10)
<a name="l00878"></a>00878               {
<a name="l00879"></a>00879                 <span class="keywordflow">if</span>(!ask(wxT(<span class="stringliteral">&quot;You just started a game. Are you sure you want to launch again?\n\nSome games may take a few seconds to start.&quot;</span>)))
<a name="l00880"></a>00880                   <span class="keywordflow">return</span>;
<a name="l00881"></a>00881               }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883             <span class="comment">// Program to launch</span>
<a name="l00884"></a>00884             boost::filesystem::path program = dir / e.entry.tigInfo.launch;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886             <span class="keywordflow">if</span>((wxGetOsVersion() &amp; wxOS_WINDOWS) == 0)
<a name="l00887"></a>00887               errorBox(wxT(<span class="stringliteral">&quot;WARNING: Launching will probably not work on your platform.\n&quot;</span>));
<a name="l00888"></a>00888 
<a name="l00889"></a>00889             <span class="comment">// Change the working directory before running. Since none</span>
<a name="l00890"></a>00890             <span class="comment">// of our own code uses relative paths, this should not</span>
<a name="l00891"></a>00891             <span class="comment">// affect our own operation.</span>
<a name="l00892"></a>00892             boost::filesystem::path workDir;
<a name="l00893"></a>00893 
<a name="l00894"></a>00894             <span class="comment">// Calculate full working directory path</span>
<a name="l00895"></a>00895             <span class="keywordflow">if</span>(e.entry.tigInfo.subdir != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00896"></a>00896               <span class="comment">// Use user-requested sub-directory</span>
<a name="l00897"></a>00897               workDir = dir / e.entry.tigInfo.subdir;
<a name="l00898"></a>00898             <span class="keywordflow">else</span>
<a name="l00899"></a>00899               <span class="comment">// Use base path of the executable</span>
<a name="l00900"></a>00900               workDir = program.parent_path();
<a name="l00901"></a>00901 
<a name="l00902"></a>00902             wxSetWorkingDirectory(wxString(workDir.string().c_str(), wxConvUTF8));
<a name="l00903"></a>00903 
<a name="l00904"></a>00904             wxString command = wxString(program.string().c_str(), wxConvUTF8);
<a name="l00905"></a>00905 
<a name="l00906"></a>00906             <span class="keywordtype">int</span> res = wxExecute(command);
<a name="l00907"></a>00907             <span class="keywordflow">if</span>(res == -1)
<a name="l00908"></a>00908               errorBox(wxT(<span class="stringliteral">&quot;Failed to launch &quot;</span>) + command);
<a name="l00909"></a>00909 
<a name="l00910"></a>00910             <span class="comment">// Update the last launch time</span>
<a name="l00911"></a>00911             last_launch = now;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913             <span class="comment">/* wxExecute allows a callback for when the program exists</span>
<a name="l00914"></a>00914 <span class="comment">               as well, letting us do things like (optionally)</span>
<a name="l00915"></a>00915 <span class="comment">               disabling downloads while running the program. I assume</span>
<a name="l00916"></a>00916 <span class="comment">               this needs to be handled in a thread-like reentrant</span>
<a name="l00917"></a>00917 <span class="comment">               manner, and we also need an intuitive backup plan in</span>
<a name="l00918"></a>00918 <span class="comment">               case the callback is never called, or if it&#39;s called</span>
<a name="l00919"></a>00919 <span class="comment">               several times.</span>
<a name="l00920"></a>00920 <span class="comment">            */</span>
<a name="l00921"></a>00921           }
<a name="l00922"></a>00922         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(b == 2)
<a name="l00923"></a>00923           {
<a name="l00924"></a>00924             <span class="comment">// Button2 == Uninstall</span>
<a name="l00925"></a>00925 
<a name="l00926"></a>00926             <span class="comment">// Are you sure?</span>
<a name="l00927"></a>00927             <span class="keywordflow">if</span>(!ask(wxT(<span class="stringliteral">&quot;Are you sure you want to uninstall &quot;</span>) + e.name +
<a name="l00928"></a>00928                     wxT(<span class="stringliteral">&quot;? All savegames and configuration will be lost.&quot;</span>)))
<a name="l00929"></a>00929               <span class="keywordflow">return</span>;
<a name="l00930"></a>00930 
<a name="l00931"></a>00931             <span class="keywordflow">try</span>
<a name="l00932"></a>00932               {
<a name="l00933"></a>00933                 <span class="comment">// First, make sure we are not killing our own working</span>
<a name="l00934"></a>00934                 <span class="comment">// directory.</span>
<a name="l00935"></a>00935                 wxSetWorkingDirectory(wxString(<span class="keyword">get</span>.base.string().c_str(), wxConvUTF8));
<a name="l00936"></a>00936 
<a name="l00937"></a>00937                 <span class="comment">// Kill all the files</span>
<a name="l00938"></a>00938                 boost::filesystem::remove_all(dir);
<a name="l00939"></a>00939 
<a name="l00940"></a>00940                 <span class="comment">// Revert status</span>
<a name="l00941"></a>00941                 GameInfo::conv(lister.get(index)).setUninstalled();
<a name="l00942"></a>00942                 <span class="keywordflow">if</span>(index == select) fixButtons();
<a name="l00943"></a>00943                 list-&gt;RefreshItem(index);
<a name="l00944"></a>00944 
<a name="l00945"></a>00945                 <span class="comment">// Notify the system that a game has changed status</span>
<a name="l00946"></a>00946                 statusChanged();
<a name="l00947"></a>00947               }
<a name="l00948"></a>00948             <span class="keywordflow">catch</span>(exception &amp;ex)
<a name="l00949"></a>00949               {
<a name="l00950"></a>00950                 wxString msg = wxT(<span class="stringliteral">&quot;Could not uninstall &quot;</span>) + e.name +
<a name="l00951"></a>00951                   wxT(<span class="stringliteral">&quot;: &quot;</span>) + wxString(<span class="keywordtype">string</span>(ex.what()).c_str(), wxConvUTF8)
<a name="l00952"></a>00952                   + wxT(<span class="stringliteral">&quot;\nPerhaps the game is still running?&quot;</span>);
<a name="l00953"></a>00953                 errorBox(msg);
<a name="l00954"></a>00954               }
<a name="l00955"></a>00955           }
<a name="l00956"></a>00956       }
<a name="l00957"></a>00957   }
<a name="l00958"></a>00958 
<a name="l00959"></a>00959   <span class="keywordtype">void</span> onGamePage(wxCommandEvent &amp;event)
<a name="l00960"></a>00960   {
<a name="l00961"></a>00961     <span class="keywordflow">if</span>(select &lt; 0 || select &gt;= lister.size())
<a name="l00962"></a>00962       <span class="keywordflow">return</span>;
<a name="l00963"></a>00963 
<a name="l00964"></a>00964     <span class="keyword">const</span> <a class="code" href="struct_game_info.html">GameInfo</a> &amp;e = GameInfo::conv(lister.get(select));
<a name="l00965"></a>00965 
<a name="l00966"></a>00966     wxString url;
<a name="l00967"></a>00967 
<a name="l00968"></a>00968     <span class="comment">// Default url is the homepage</span>
<a name="l00969"></a>00969     <span class="keywordflow">if</span>(e.entry.tigInfo.homepage != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00970"></a>00970       <span class="comment">// Game homepage, if it exists</span>
<a name="l00971"></a>00971       url = wxString(e.entry.tigInfo.homepage.c_str(), wxConvUTF8);
<a name="l00972"></a>00972     <span class="keywordflow">else</span>
<a name="l00973"></a>00973       <span class="comment">// If not, use the tiggit page</span>
<a name="l00974"></a>00974       url = wxT(<span class="stringliteral">&quot;http://tiggit.net/game/&quot;</span>) + e.urlname;
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     <span class="comment">// Only used from context menus</span>
<a name="l00977"></a>00977     <span class="keywordflow">if</span>(event.GetId() == myID_TIGGIT_PAGE)
<a name="l00978"></a>00978       url = wxT(<span class="stringliteral">&quot;http://tiggit.net/game/&quot;</span>) + e.urlname;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(event.GetId() == myID_SUPPORT)
<a name="l00981"></a>00981       {
<a name="l00982"></a>00982         <span class="comment">// Is it a demo?</span>
<a name="l00983"></a>00983         <span class="keywordflow">if</span>(e.entry.tigInfo.isDemo)
<a name="l00984"></a>00984           {
<a name="l00985"></a>00985             <span class="comment">// Redirect to the buy page, if any</span>
<a name="l00986"></a>00986             <span class="keywordflow">if</span>(e.entry.tigInfo.buypage != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00987"></a>00987               url = wxString(e.entry.tigInfo.buypage.c_str(), wxConvUTF8);
<a name="l00988"></a>00988 
<a name="l00989"></a>00989             <span class="comment">// Otherwise, the homepage already set up in &#39;url&#39; is</span>
<a name="l00990"></a>00990             <span class="comment">// fine.</span>
<a name="l00991"></a>00991 
<a name="l00992"></a>00992             <span class="comment">// Warn the user that you can&#39;t actually download finished</span>
<a name="l00993"></a>00993             <span class="comment">// games here yet</span>
<a name="l00994"></a>00994             <span class="keywordflow">if</span>(!conf.seen_demo_msg)
<a name="l00995"></a>00995               wxMessageBox(wxT(<span class="stringliteral">&quot;NOTE: Purchasing of games happens entirely outside of the tiggit system. We have not yet integrated any shopping functions into the launcher itself.\n\nWe still encourage you to buy games, but unfortunately you will NOT currently be able to find or play these newly purchased games inside the tiggit launcher. Instead you must download, install and run these games manually.\n\nWe know this is inconvenient, so this is something we hope to improve in the near future, in cooperation with game developers.&quot;</span>),
<a name="l00996"></a>00996                            wxT(<span class="stringliteral">&quot;Warning&quot;</span>), wxOK);
<a name="l00997"></a>00997 
<a name="l00998"></a>00998             conf.shown_demo_msg();
<a name="l00999"></a>00999           }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001         <span class="keywordflow">else</span>
<a name="l01002"></a>01002           <span class="comment">// Not a demo. Redirect to the support page.</span>
<a name="l01003"></a>01003           url = wxT(<span class="stringliteral">&quot;http://tiggit.net/game/&quot;</span>) + e.urlname + wxT(<span class="stringliteral">&quot;&amp;donate&quot;</span>);
<a name="l01004"></a>01004       }
<a name="l01005"></a>01005 
<a name="l01006"></a>01006     wxLaunchDefaultBrowser(url);
<a name="l01007"></a>01007   }
<a name="l01008"></a>01008 
<a name="l01009"></a>01009   <span class="keywordtype">void</span> onButton(wxCommandEvent &amp;event)
<a name="l01010"></a>01010   {
<a name="l01011"></a>01011     <span class="keywordtype">int</span> b = <span class="keyword">event</span>.GetId()-20;
<a name="l01012"></a>01012     doAction(select, b);
<a name="l01013"></a>01013     list-&gt;SetFocus();
<a name="l01014"></a>01014   }
<a name="l01015"></a>01015 
<a name="l01016"></a>01016   <span class="keywordtype">void</span> onListDeselect(wxListEvent &amp;event)
<a name="l01017"></a>01017   {
<a name="l01018"></a>01018     select = -1;
<a name="l01019"></a>01019     updateSelection();
<a name="l01020"></a>01020   }
<a name="l01021"></a>01021 
<a name="l01022"></a>01022   <span class="keywordtype">void</span> onListSelect(wxListEvent &amp;event)
<a name="l01023"></a>01023   {
<a name="l01024"></a>01024     select = <span class="keyword">event</span>.GetIndex();
<a name="l01025"></a>01025     updateSelection();
<a name="l01026"></a>01026   }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028   <span class="keywordtype">void</span> onListRightClick(wxListEvent &amp;event)
<a name="l01029"></a>01029   {
<a name="l01030"></a>01030     <span class="keywordflow">if</span>(select &lt; 0 || select &gt;= lister.size())
<a name="l01031"></a>01031       <span class="keywordflow">return</span>;
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     <span class="keyword">const</span> <a class="code" href="struct_game_info.html">GameInfo</a> &amp;e = GameInfo::conv(lister.get(select));
<a name="l01034"></a>01034 
<a name="l01035"></a>01035     <span class="comment">// Set up context menu</span>
<a name="l01036"></a>01036     wxMenu menu;
<a name="l01037"></a>01037 
<a name="l01038"></a>01038     <span class="comment">// Set up custom event handler for the menu</span>
<a name="l01039"></a>01039     menu.Connect(wxEVT_COMMAND_MENU_SELECTED,
<a name="l01040"></a>01040                  (wxObjectEventFunction)&amp;ListTab::onContextClick, NULL, <span class="keyword">this</span>);
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <span class="comment">// State-dependent actions</span>
<a name="l01043"></a>01043     <span class="keywordflow">if</span>(e.isNone())
<a name="l01044"></a>01044       menu.Append(myID_BUTTON1, wxT(<span class="stringliteral">&quot;Install&quot;</span>));
<a name="l01045"></a>01045     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(e.isWorking())
<a name="l01046"></a>01046       menu.Append(myID_BUTTON2, wxT(<span class="stringliteral">&quot;Abort&quot;</span>));
<a name="l01047"></a>01047     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(e.isInstalled())
<a name="l01048"></a>01048       {
<a name="l01049"></a>01049         menu.Append(myID_BUTTON1, wxT(<span class="stringliteral">&quot;Play&quot;</span>));
<a name="l01050"></a>01050         menu.Append(myID_BUTTON2, wxT(<span class="stringliteral">&quot;Uninstall&quot;</span>));
<a name="l01051"></a>01051       }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     <span class="comment">// Common actions</span>
<a name="l01054"></a>01054     menu.AppendSeparator();
<a name="l01055"></a>01055     menu.Append(myID_GAMEPAGE, wxT(<span class="stringliteral">&quot;Visit Website&quot;</span>));
<a name="l01056"></a>01056     menu.Append(myID_TIGGIT_PAGE, wxT(<span class="stringliteral">&quot;Visit Tiggit.net Page&quot;</span>));
<a name="l01057"></a>01057     <span class="keywordflow">if</span>(e.entry.tigInfo.hasPaypal)
<a name="l01058"></a>01058       menu.Append(myID_SUPPORT, wxT(<span class="stringliteral">&quot;Support Developer&quot;</span>));
<a name="l01059"></a>01059 
<a name="l01060"></a>01060     <span class="comment">// Currently only supported in Windows</span>
<a name="l01061"></a>01061     <span class="keywordflow">if</span>((wxGetOsVersion() &amp; wxOS_WINDOWS) != 0)
<a name="l01062"></a>01062       <span class="keywordflow">if</span>(e.isInstalled())
<a name="l01063"></a>01063         menu.Append(myID_OPEN_LOCATION, wxT(<span class="stringliteral">&quot;Open Location&quot;</span>));
<a name="l01064"></a>01064 
<a name="l01065"></a>01065     <span class="comment">//menu.Append(myID_REFRESH_ITEM, wxT(&quot;Refresh Info&quot;));</span>
<a name="l01066"></a>01066 
<a name="l01067"></a>01067     PopupMenu(&amp;menu);
<a name="l01068"></a>01068   }
<a name="l01069"></a>01069 
<a name="l01070"></a>01070   <span class="comment">// Handle events from the context menu</span>
<a name="l01071"></a>01071   <span class="keywordtype">void</span> onContextClick(wxCommandEvent &amp;evt)
<a name="l01072"></a>01072   {
<a name="l01073"></a>01073     <span class="keywordflow">if</span>(select &lt; 0 || select &gt;= lister.size())
<a name="l01074"></a>01074       <span class="keywordflow">return</span>;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     <span class="keyword">const</span> <a class="code" href="struct_data_list_1_1_entry.html">DataList::Entry</a> &amp;e = lister.get(select);
<a name="l01077"></a>01077 
<a name="l01078"></a>01078     <span class="keywordtype">int</span> <span class="keywordtype">id</span> = evt.GetId();
<a name="l01079"></a>01079     <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == myID_BUTTON1 || <span class="keywordtype">id</span> == myID_BUTTON2)
<a name="l01080"></a>01080       onButton(evt);
<a name="l01081"></a>01081 
<a name="l01082"></a>01082     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == myID_GAMEPAGE || <span class="keywordtype">id</span> == myID_SUPPORT || <span class="keywordtype">id</span> == myID_TIGGIT_PAGE)
<a name="l01083"></a>01083       onGamePage(evt);
<a name="l01084"></a>01084 
<a name="l01085"></a>01085     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == myID_OPEN_LOCATION)
<a name="l01086"></a>01086       {
<a name="l01087"></a>01087         boost::filesystem::path dir = <span class="stringliteral">&quot;data&quot;</span>;
<a name="l01088"></a>01088         dir /= e.idname;
<a name="l01089"></a>01089         dir = <span class="keyword">get</span>.getPath(dir.string());
<a name="l01090"></a>01090 
<a name="l01091"></a>01091         <span class="keywordflow">if</span>((wxGetOsVersion() &amp; wxOS_WINDOWS) != 0)
<a name="l01092"></a>01092           {
<a name="l01093"></a>01093             <span class="keywordtype">string</span> cmd = <span class="stringliteral">&quot;explorer \&quot;&quot;</span> + dir.string() + <span class="stringliteral">&quot;\&quot;&quot;</span>;
<a name="l01094"></a>01094             wxString command(cmd.c_str(), wxConvUTF8);
<a name="l01095"></a>01095             <span class="keywordtype">int</span> res = wxExecute(command);
<a name="l01096"></a>01096             <span class="keywordflow">if</span>(res == -1)
<a name="l01097"></a>01097               errorBox(wxT(<span class="stringliteral">&quot;Failed to launch &quot;</span>) + command);
<a name="l01098"></a>01098           }
<a name="l01099"></a>01099       }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == myID_REFRESH_ITEM)
<a name="l01102"></a>01102       cout &lt;&lt; <span class="stringliteral">&quot;Individual tig refresh isn&#39;t implemented yet!\n&quot;</span>;
<a name="l01103"></a>01103   }
<a name="l01104"></a>01104 
<a name="l01105"></a>01105   <span class="keywordtype">void</span> onListActivate(wxListEvent &amp;event)
<a name="l01106"></a>01106   {
<a name="l01107"></a>01107     doAction(event.GetIndex(), 3);
<a name="l01108"></a>01108   }
<a name="l01109"></a>01109 
<a name="l01110"></a>01110   <span class="keywordtype">void</span> dataChanged()
<a name="l01111"></a>01111   {
<a name="l01112"></a>01112     lister.reset();
<a name="l01113"></a>01113     createTagList();
<a name="l01114"></a>01114     listHasChanged(<span class="keyword">true</span>);
<a name="l01115"></a>01115   }
<a name="l01116"></a>01116 };
<a name="l01117"></a>01117 
<a name="l01118"></a>01118 <span class="comment">/* A cludge to work around C++&#39;s crappy handling of virtual</span>
<a name="l01119"></a>01119 <span class="comment">   functions. This function should be virtual in ListTab, but then the</span>
<a name="l01120"></a>01120 <span class="comment">   constructor doesn&#39;t call the right one.</span>
<a name="l01121"></a>01121 <span class="comment"> */</span>
<a name="l01122"></a><a class="code" href="struct_game_sort_options.html">01122</a> <span class="keyword">struct </span><a class="code" href="struct_game_sort_options.html">GameSortOptions</a> : <a class="code" href="struct_sort_options.html">SortOptions</a>
<a name="l01123"></a>01123 {
<a name="l01124"></a>01124   <span class="keywordtype">void</span> addSortOptions(wxWindow *parent, wxBoxSizer *pane)<span class="keyword"> const</span>
<a name="l01125"></a>01125 <span class="keyword">  </span>{
<a name="l01126"></a>01126     pane-&gt;Add(<span class="keyword">new</span> wxRadioButton(parent, myID_SORT_TITLE, wxT(<span class="stringliteral">&quot;Sort by title&quot;</span>),
<a name="l01127"></a>01127                                 wxDefaultPosition, wxDefaultSize, wxRB_GROUP),
<a name="l01128"></a>01128               0, wxRIGHT, 10);
<a name="l01129"></a>01129     pane-&gt;Add(<span class="keyword">new</span> wxRadioButton(parent, myID_SORT_DATE, wxT(<span class="stringliteral">&quot;Sort by date&quot;</span>)),
<a name="l01130"></a>01130               0, wxRIGHT, 10);
<a name="l01131"></a>01131   }
<a name="l01132"></a>01132 };
<a name="l01133"></a>01133 
<a name="l01134"></a>01134 <span class="comment">// List tab that only displays itself when non-empty</span>
<a name="l01135"></a><a class="code" href="struct_list_tab_non_empty.html">01135</a> <span class="keyword">struct </span><a class="code" href="struct_list_tab_non_empty.html">ListTabNonEmpty</a> : <a class="code" href="struct_list_tab.html">ListTab</a>
<a name="l01136"></a>01136 {
<a name="l01137"></a>01137   <a class="code" href="struct_list_tab_non_empty.html">ListTabNonEmpty</a>(wxNotebook *parent, <span class="keyword">const</span> wxString &amp;name, <span class="keywordtype">int</span> listType,
<a name="l01138"></a>01138                   <a class="code" href="struct_status_notify.html">StatusNotify</a> *s, <span class="keyword">const</span> <a class="code" href="struct_sort_options.html">SortOptions</a> *sop = NULL)
<a name="l01139"></a>01139     : <a class="code" href="struct_list_tab.html">ListTab</a>(parent, name, listType, s, sop)
<a name="l01140"></a>01140   {}
<a name="l01141"></a>01141 
<a name="l01142"></a>01142   <span class="keywordtype">void</span> insertMe()
<a name="l01143"></a>01143   {
<a name="l01144"></a>01144     tabNum = -1;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146     <span class="comment">// Only show the &quot;New&quot; tab if there are new games to show.</span>
<a name="l01147"></a>01147     <span class="keywordflow">if</span>(lister.baseSize() &gt; 0)
<a name="l01148"></a>01148       {
<a name="l01149"></a>01149         Show();
<a name="l01150"></a>01150         ListTab::insertMe();
<a name="l01151"></a>01151       }
<a name="l01152"></a>01152     <span class="keywordflow">else</span>
<a name="l01153"></a>01153       Hide();
<a name="l01154"></a>01154   }
<a name="l01155"></a>01155 };
<a name="l01156"></a>01156 
<a name="l01157"></a>01157 <span class="comment">// Lists newly added games</span>
<a name="l01158"></a><a class="code" href="struct_new_game_list_tab.html">01158</a> <span class="keyword">struct </span><a class="code" href="struct_new_game_list_tab.html">NewGameListTab</a> : <a class="code" href="struct_list_tab_non_empty.html">ListTabNonEmpty</a>
<a name="l01159"></a>01159 {
<a name="l01160"></a>01160   <a class="code" href="struct_new_game_list_tab.html">NewGameListTab</a>(wxNotebook *parent, <a class="code" href="struct_status_notify.html">StatusNotify</a> *s)
<a name="l01161"></a>01161     : <a class="code" href="struct_list_tab_non_empty.html">ListTabNonEmpty</a>(parent, wxT(<span class="stringliteral">&quot;New&quot;</span>), ListKeeper::SL_NEW, s, <span class="keyword">new</span> <a class="code" href="struct_game_sort_options.html">GameSortOptions</a>)
<a name="l01162"></a>01162   {
<a name="l01163"></a>01163     list-&gt;addColumn(wxT(<span class="stringliteral">&quot;Name&quot;</span>), 300, <span class="keyword">new</span> <a class="code" href="struct_title_col.html">TitleCol</a>);
<a name="l01164"></a>01164     list-&gt;addColumn(wxT(<span class="stringliteral">&quot;Type&quot;</span>), 140, <span class="keyword">new</span> <a class="code" href="struct_type_col.html">TypeCol</a>);
<a name="l01165"></a>01165   }
<a name="l01166"></a>01166 };
<a name="l01167"></a>01167 
<a name="l01168"></a>01168 <span class="comment">// Lists freeware games</span>
<a name="l01169"></a><a class="code" href="struct_freeware_list_tab.html">01169</a> <span class="keyword">struct </span><a class="code" href="struct_freeware_list_tab.html">FreewareListTab</a> : <a class="code" href="struct_list_tab.html">ListTab</a>
<a name="l01170"></a>01170 {
<a name="l01171"></a>01171   <a class="code" href="struct_freeware_list_tab.html">FreewareListTab</a>(wxNotebook *parent, <a class="code" href="struct_status_notify.html">StatusNotify</a> *s)
<a name="l01172"></a>01172     : <a class="code" href="struct_list_tab.html">ListTab</a>(parent, wxT(<span class="stringliteral">&quot;Browse&quot;</span>), ListKeeper::SL_FREEWARE, s, <span class="keyword">new</span> <a class="code" href="struct_game_sort_options.html">GameSortOptions</a>)
<a name="l01173"></a>01173   {
<a name="l01174"></a>01174     list-&gt;addColumn(wxT(<span class="stringliteral">&quot;Name&quot;</span>), 300, <span class="keyword">new</span> <a class="code" href="struct_title_col.html">TitleCol</a>);
<a name="l01175"></a>01175     list-&gt;addColumn(wxT(<span class="stringliteral">&quot;Rating&quot;</span>), 70, <span class="keyword">new</span> <a class="code" href="struct_rating_col.html">RatingCol</a>);
<a name="l01176"></a>01176     <span class="keywordflow">if</span>(conf.debug)
<a name="l01177"></a>01177       list-&gt;addColumn(wxT(<span class="stringliteral">&quot;Downloads&quot;</span>), 70, <span class="keyword">new</span> <a class="code" href="struct_downloads_col.html">DownloadsCol</a>);
<a name="l01178"></a>01178 
<a name="l01179"></a>01179     lister.sortRating();
<a name="l01180"></a>01180     listHasChanged();
<a name="l01181"></a>01181   }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183   <span class="comment">// Temporary development hack</span>
<a name="l01184"></a>01184   <span class="keywordtype">void</span> insertMe()
<a name="l01185"></a>01185   {
<a name="l01186"></a>01186     <span class="keywordflow">if</span>(gHasDemos)
<a name="l01187"></a>01187       tabName = wxT(<span class="stringliteral">&quot;Freeware&quot;</span>);
<a name="l01188"></a>01188     <span class="keywordflow">else</span>
<a name="l01189"></a>01189       tabName = wxT(<span class="stringliteral">&quot;Browse&quot;</span>);
<a name="l01190"></a>01190 
<a name="l01191"></a>01191     ListTab::insertMe();
<a name="l01192"></a>01192   }
<a name="l01193"></a>01193 };
<a name="l01194"></a>01194 
<a name="l01195"></a><a class="code" href="struct_demo_list_tab.html">01195</a> <span class="keyword">struct </span><a class="code" href="struct_demo_list_tab.html">DemoListTab</a> : <a class="code" href="struct_list_tab_non_empty.html">ListTabNonEmpty</a>
<a name="l01196"></a>01196 {
<a name="l01197"></a>01197   <a class="code" href="struct_demo_list_tab.html">DemoListTab</a>(wxNotebook *parent, <a class="code" href="struct_status_notify.html">StatusNotify</a> *s)
<a name="l01198"></a>01198     : <a class="code" href="struct_list_tab_non_empty.html">ListTabNonEmpty</a>(parent, wxT(<span class="stringliteral">&quot;Demos&quot;</span>), ListKeeper::SL_DEMOS, s, <span class="keyword">new</span> <a class="code" href="struct_game_sort_options.html">GameSortOptions</a>)
<a name="l01199"></a>01199   {
<a name="l01200"></a>01200     list-&gt;addColumn(wxT(<span class="stringliteral">&quot;Name&quot;</span>), 300, <span class="keyword">new</span> <a class="code" href="struct_title_col.html">TitleCol</a>);
<a name="l01201"></a>01201     list-&gt;addColumn(wxT(<span class="stringliteral">&quot;Rating&quot;</span>), 70, <span class="keyword">new</span> <a class="code" href="struct_rating_col.html">RatingCol</a>);
<a name="l01202"></a>01202     <span class="keywordflow">if</span>(conf.debug)
<a name="l01203"></a>01203       list-&gt;addColumn(wxT(<span class="stringliteral">&quot;Downloads&quot;</span>), 70, <span class="keyword">new</span> <a class="code" href="struct_downloads_col.html">DownloadsCol</a>);
<a name="l01204"></a>01204     <span class="comment">//list-&gt;addColumn(wxT(&quot;Price&quot;), 70, new PriceCol);</span>
<a name="l01205"></a>01205 
<a name="l01206"></a>01206     lister.sortRating();
<a name="l01207"></a>01207     listHasChanged();
<a name="l01208"></a>01208   }
<a name="l01209"></a>01209 };
<a name="l01210"></a>01210 
<a name="l01211"></a><a class="code" href="struct_installed_list_tab.html">01211</a> <span class="keyword">struct </span><a class="code" href="struct_installed_list_tab.html">InstalledListTab</a> : <a class="code" href="struct_list_tab.html">ListTab</a>
<a name="l01212"></a>01212 {
<a name="l01213"></a>01213   <a class="code" href="struct_installed_list_tab.html">InstalledListTab</a>(wxNotebook *parent, <a class="code" href="struct_status_notify.html">StatusNotify</a> *s)
<a name="l01214"></a>01214     : <a class="code" href="struct_list_tab.html">ListTab</a>(parent, wxT(<span class="stringliteral">&quot;Installed&quot;</span>), ListKeeper::SL_INSTALL, s)
<a name="l01215"></a>01215   {
<a name="l01216"></a>01216     list-&gt;addColumn(wxT(<span class="stringliteral">&quot;Name&quot;</span>), 300, <span class="keyword">new</span> <a class="code" href="struct_title_col.html">TitleCol</a>);
<a name="l01217"></a>01217     list-&gt;addColumn(wxT(<span class="stringliteral">&quot;Status&quot;</span>), 170, <span class="keyword">new</span> <a class="code" href="struct_status_col.html">StatusCol</a>);
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     <span class="comment">// Add delete = 2nd button accelerator</span>
<a name="l01220"></a>01220     wxAcceleratorEntry entries[1];
<a name="l01221"></a>01221     entries[0].Set(wxACCEL_NORMAL, WXK_DELETE, myID_BUTTON2);
<a name="l01222"></a>01222     wxAcceleratorTable accel(1, entries);
<a name="l01223"></a>01223     SetAcceleratorTable(accel);
<a name="l01224"></a>01224   }
<a name="l01225"></a>01225 
<a name="l01226"></a>01226   <span class="keywordtype">void</span> tick()
<a name="l01227"></a>01227   {
<a name="l01228"></a>01228     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;lister.size(); i++)
<a name="l01229"></a>01229       updateStatus(i);
<a name="l01230"></a>01230   }
<a name="l01231"></a>01231 };
<a name="l01232"></a>01232 
<a name="l01233"></a>01233 <span class="preprocessor">#define myID_MENU_REFRESH 30</span>
<a name="l01234"></a>01234 <span class="preprocessor"></span><span class="preprocessor">#define myID_MENU_REFRESH_TOTAL 20031</span>
<a name="l01235"></a>01235 <span class="preprocessor"></span><span class="preprocessor">#define myID_GOLEFT 31</span>
<a name="l01236"></a>01236 <span class="preprocessor"></span><span class="preprocessor">#define myID_GORIGHT 32</span>
<a name="l01237"></a>01237 <span class="preprocessor"></span><span class="preprocessor">#define myID_BOOK 33</span>
<a name="l01238"></a>01238 <span class="preprocessor"></span>
<a name="l01239"></a><a class="code" href="class_my_frame.html">01239</a> <span class="keyword">class </span><a class="code" href="class_my_frame.html">MyFrame</a> : <span class="keyword">public</span> wxFrame, <span class="keyword">public</span> <a class="code" href="struct_status_notify.html">StatusNotify</a>
<a name="l01240"></a>01240 {
<a name="l01241"></a>01241   std::string version;
<a name="l01242"></a>01242   wxNotebook *book;
<a name="l01243"></a>01243 
<a name="l01244"></a>01244   <a class="code" href="struct_new_game_list_tab.html">NewGameListTab</a> *newTab;
<a name="l01245"></a>01245   <a class="code" href="struct_freeware_list_tab.html">FreewareListTab</a> *freewareTab;
<a name="l01246"></a>01246   <a class="code" href="struct_demo_list_tab.html">DemoListTab</a> *demoTab;
<a name="l01247"></a>01247   <a class="code" href="struct_installed_list_tab.html">InstalledListTab</a> *installedTab;
<a name="l01248"></a>01248   <a class="code" href="struct_news_tab.html">NewsTab</a> *newsTab;
<a name="l01249"></a>01249 
<a name="l01250"></a>01250 <span class="keyword">public</span>:
<a name="l01251"></a>01251   <a class="code" href="class_my_frame.html">MyFrame</a>(<span class="keyword">const</span> wxString&amp; title, <span class="keyword">const</span> std::string &amp;ver)
<a name="l01252"></a>01252     : wxFrame(NULL, wxID_ANY, title, wxDefaultPosition, wxSize(1024, 700)),
<a name="l01253"></a>01253       version(ver)
<a name="l01254"></a>01254   {
<a name="l01255"></a>01255     Centre();
<a name="l01256"></a>01256 
<a name="l01257"></a>01257     wxMenu *menuFile = <span class="keyword">new</span> wxMenu;
<a name="l01258"></a>01258 
<a name="l01259"></a>01259     <span class="comment">/*</span>
<a name="l01260"></a>01260 <span class="comment">    menuFile-&gt;Append(wxID_ABOUT, _(&quot;&amp;About...&quot;));</span>
<a name="l01261"></a>01261 <span class="comment">    menuFile-&gt;AppendSeparator();</span>
<a name="l01262"></a>01262 <span class="comment">    */</span>
<a name="l01263"></a>01263     menuFile-&gt;Append(wxID_EXIT, _(<span class="stringliteral">&quot;E&amp;xit&quot;</span>));
<a name="l01264"></a>01264 
<a name="l01265"></a>01265     wxMenu *menuList = <span class="keyword">new</span> wxMenu;
<a name="l01266"></a>01266     menuList-&gt;Append(myID_MENU_REFRESH, wxT(<span class="stringliteral">&quot;&amp;Reload List&quot;</span>));
<a name="l01267"></a>01267     <span class="comment">//menuList-&gt;Append(myID_MENU_REFRESH_TOTAL, wxT(&quot;Reload E&amp;verything&quot;));</span>
<a name="l01268"></a>01268 
<a name="l01269"></a>01269     wxMenuBar *menuBar = <span class="keyword">new</span> wxMenuBar;
<a name="l01270"></a>01270     menuBar-&gt;Append(menuFile, _(<span class="stringliteral">&quot;&amp;App&quot;</span>));
<a name="l01271"></a>01271     menuBar-&gt;Append(menuList, _(<span class="stringliteral">&quot;&amp;List&quot;</span>));
<a name="l01272"></a>01272 
<a name="l01273"></a>01273     SetMenuBar( menuBar );
<a name="l01274"></a>01274 
<a name="l01275"></a>01275     CreateStatusBar();
<a name="l01276"></a>01276     SetStatusText(wxString((<span class="stringliteral">&quot;Welcome to tiggit - version &quot;</span> + ver).c_str(), wxConvUTF8));
<a name="l01277"></a>01277 
<a name="l01278"></a>01278     <span class="comment">// Without this the menubar doesn&#39;t appear (in GTK on Linux) until</span>
<a name="l01279"></a>01279     <span class="comment">// you move the mouse. Probably some weird bug.</span>
<a name="l01280"></a>01280     SendSizeEvent();
<a name="l01281"></a>01281 
<a name="l01282"></a>01282     wxPanel *panel = <span class="keyword">new</span> wxPanel(<span class="keyword">this</span>);
<a name="l01283"></a>01283     book = <span class="keyword">new</span> wxNotebook(panel, myID_BOOK);
<a name="l01284"></a>01284 
<a name="l01285"></a>01285     <span class="comment">// Set up the tabs. They are inserted further down through</span>
<a name="l01286"></a>01286     newTab = <span class="keyword">new</span> <a class="code" href="struct_new_game_list_tab.html">NewGameListTab</a>(book, <span class="keyword">this</span>);
<a name="l01287"></a>01287     freewareTab = <span class="keyword">new</span> <a class="code" href="struct_freeware_list_tab.html">FreewareListTab</a>(book, <span class="keyword">this</span>);
<a name="l01288"></a>01288     demoTab = <span class="keyword">new</span> <a class="code" href="struct_demo_list_tab.html">DemoListTab</a>(book, <span class="keyword">this</span>);
<a name="l01289"></a>01289     installedTab = <span class="keyword">new</span> <a class="code" href="struct_installed_list_tab.html">InstalledListTab</a>(book, <span class="keyword">this</span>);
<a name="l01290"></a>01290     newsTab = <span class="keyword">new</span> <a class="code" href="struct_news_tab.html">NewsTab</a>(book);
<a name="l01291"></a>01291 
<a name="l01292"></a>01292     wxBoxSizer *mainSizer = <span class="keyword">new</span> wxBoxSizer(wxVERTICAL);
<a name="l01293"></a>01293     mainSizer-&gt;Add(book, 1, wxGROW | wxALL, 10);
<a name="l01294"></a>01294 
<a name="l01295"></a>01295     panel-&gt;SetSizer(mainSizer);
<a name="l01296"></a>01296 
<a name="l01297"></a>01297     <span class="comment">/* Add left/right =&gt; control tabs</span>
<a name="l01298"></a>01298 <span class="comment"></span>
<a name="l01299"></a>01299 <span class="comment">       This works on Linux but unfortunately not on Windows, and I</span>
<a name="l01300"></a>01300 <span class="comment">       don&#39;t know why.</span>
<a name="l01301"></a>01301 <span class="comment">     */</span>
<a name="l01302"></a>01302 
<a name="l01303"></a>01303     <span class="comment">/*</span>
<a name="l01304"></a>01304 <span class="comment">      DISABLED for now since they messes up the search text box.</span>
<a name="l01305"></a>01305 <span class="comment"></span>
<a name="l01306"></a>01306 <span class="comment">    wxAcceleratorEntry entries[2];</span>
<a name="l01307"></a>01307 <span class="comment">    entries[0].Set(wxACCEL_NORMAL, WXK_LEFT, myID_GOLEFT);</span>
<a name="l01308"></a>01308 <span class="comment">    entries[1].Set(wxACCEL_NORMAL, WXK_RIGHT, myID_GORIGHT);</span>
<a name="l01309"></a>01309 <span class="comment">    wxAcceleratorTable accel(2, entries);</span>
<a name="l01310"></a>01310 <span class="comment">    SetAcceleratorTable(accel);</span>
<a name="l01311"></a>01311 <span class="comment">    */</span>
<a name="l01312"></a>01312 
<a name="l01313"></a>01313     Connect(wxID_ABOUT, wxEVT_COMMAND_MENU_SELECTED,
<a name="l01314"></a>01314             wxCommandEventHandler(MyFrame::onAbout));
<a name="l01315"></a>01315     Connect(wxID_EXIT, wxEVT_COMMAND_MENU_SELECTED,
<a name="l01316"></a>01316             wxCommandEventHandler(MyFrame::onExit));
<a name="l01317"></a>01317     Connect(myID_MENU_REFRESH, wxEVT_COMMAND_MENU_SELECTED,
<a name="l01318"></a>01318             wxCommandEventHandler(MyFrame::onRefresh));
<a name="l01319"></a>01319     Connect(myID_MENU_REFRESH_TOTAL, wxEVT_COMMAND_MENU_SELECTED,
<a name="l01320"></a>01320             wxCommandEventHandler(MyFrame::onRefresh));
<a name="l01321"></a>01321 
<a name="l01322"></a>01322     Connect(myID_GOLEFT, wxEVT_COMMAND_BUTTON_CLICKED,
<a name="l01323"></a>01323             wxCommandEventHandler(MyFrame::onLeftRight));
<a name="l01324"></a>01324     Connect(myID_GORIGHT, wxEVT_COMMAND_BUTTON_CLICKED,
<a name="l01325"></a>01325             wxCommandEventHandler(MyFrame::onLeftRight));
<a name="l01326"></a>01326 
<a name="l01327"></a>01327     setTabFocus();
<a name="l01328"></a>01328     setupTabs();
<a name="l01329"></a>01329   }
<a name="l01330"></a>01330 
<a name="l01331"></a>01331   <a class="code" href="struct_tab_base.html">TabBase</a> *getTab(<span class="keywordtype">int</span> i)
<a name="l01332"></a>01332   {
<a name="l01333"></a>01333     assert(book);
<a name="l01334"></a>01334     <a class="code" href="struct_tab_base.html">TabBase</a> *res = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="struct_tab_base.html">TabBase</a>*<span class="keyword">&gt;</span>(book-&gt;GetPage(i));
<a name="l01335"></a>01335     assert(res);
<a name="l01336"></a>01336     <span class="keywordflow">return</span> res;
<a name="l01337"></a>01337   }
<a name="l01338"></a>01338 
<a name="l01339"></a>01339   <span class="comment">/* Get current tab. Note: Do NOT use this in tab selection event</span>
<a name="l01340"></a>01340 <span class="comment">     handling! Because it may refer to EITHER the new or the old tab,</span>
<a name="l01341"></a>01341 <span class="comment">     depending on platform. Use wxNotebookEvent::GetSelection instead.</span>
<a name="l01342"></a>01342 <span class="comment"></span>
<a name="l01343"></a>01343 <span class="comment">     May return NULL if no tab is selected.</span>
<a name="l01344"></a>01344 <span class="comment">   */</span>
<a name="l01345"></a>01345   <a class="code" href="struct_tab_base.html">TabBase</a> *getCurrentTab()
<a name="l01346"></a>01346   {
<a name="l01347"></a>01347     <span class="keywordtype">int</span> sel = book-&gt;GetSelection();
<a name="l01348"></a>01348     <span class="keywordflow">if</span>(sel &gt;= 0) <span class="keywordflow">return</span> getTab(sel);
<a name="l01349"></a>01349     <span class="keywordflow">return</span> NULL;
<a name="l01350"></a>01350   }
<a name="l01351"></a>01351 
<a name="l01352"></a>01352   <span class="keywordtype">void</span> setTabFocus()
<a name="l01353"></a>01353   {
<a name="l01354"></a>01354     <a class="code" href="struct_tab_base.html">TabBase</a> *t = getCurrentTab();
<a name="l01355"></a>01355     <span class="keywordflow">if</span>(t) t-&gt;takeFocus();
<a name="l01356"></a>01356   }
<a name="l01357"></a>01357 
<a name="l01358"></a>01358   <span class="keywordtype">void</span> setupTabs()
<a name="l01359"></a>01359   {
<a name="l01360"></a>01360     <span class="comment">// Remember which tab was selected</span>
<a name="l01361"></a>01361     <a class="code" href="struct_tab_base.html">TabBase</a> *sel = getCurrentTab();
<a name="l01362"></a>01362 
<a name="l01363"></a>01363     <span class="comment">// Remove all tabs</span>
<a name="l01364"></a>01364     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=book-&gt;GetPageCount()-1; i &gt;= 0; i--)
<a name="l01365"></a>01365       book-&gt;RemovePage(i);
<a name="l01366"></a>01366 
<a name="l01367"></a>01367     <span class="comment">// Remember whether we have demos or not</span>
<a name="l01368"></a>01368     gHasDemos = demoTab-&gt;lister.baseSize() != 0;
<a name="l01369"></a>01369 
<a name="l01370"></a>01370     <span class="comment">// Re-add them, if they want to be re-added</span>
<a name="l01371"></a>01371     newTab-&gt;insertMe();
<a name="l01372"></a>01372     freewareTab-&gt;insertMe();
<a name="l01373"></a>01373     demoTab-&gt;insertMe();
<a name="l01374"></a>01374     installedTab-&gt;insertMe();
<a name="l01375"></a>01375     newsTab-&gt;insertMe();
<a name="l01376"></a>01376 
<a name="l01377"></a>01377     <span class="comment">// Re-select the previously selected tab, if it exists</span>
<a name="l01378"></a>01378     <span class="keywordflow">if</span>((sel == NULL) || !sel-&gt;selectMe())
<a name="l01379"></a>01379       {
<a name="l01380"></a>01380         <span class="comment">// No previously selected tab available.</span>
<a name="l01381"></a>01381 
<a name="l01382"></a>01382         <span class="comment">// Start by selecting the &#39;new&#39; tab, if applicable</span>
<a name="l01383"></a>01383         <span class="keywordflow">if</span>(newTab-&gt;lister.baseSize() != 0)
<a name="l01384"></a>01384           newTab-&gt;selectMe();
<a name="l01385"></a>01385 
<a name="l01386"></a>01386         <span class="comment">// If not, check if there are installed games, and use that as</span>
<a name="l01387"></a>01387         <span class="comment">// the starting tab instead.</span>
<a name="l01388"></a>01388         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(installedTab-&gt;lister.baseSize() != 0)
<a name="l01389"></a>01389           installedTab-&gt;selectMe();
<a name="l01390"></a>01390 
<a name="l01391"></a>01391         <span class="comment">// If neither have any games, just start by browsing free</span>
<a name="l01392"></a>01392         <span class="comment">// games.</span>
<a name="l01393"></a>01393         <span class="keywordflow">else</span>
<a name="l01394"></a>01394           freewareTab-&gt;selectMe();
<a name="l01395"></a>01395       }
<a name="l01396"></a>01396   }
<a name="l01397"></a>01397 
<a name="l01398"></a>01398   <span class="keywordtype">void</span> onLeftRight(wxCommandEvent &amp;event)
<a name="l01399"></a>01399   {
<a name="l01400"></a>01400     book-&gt;AdvanceSelection(event.GetId() == myID_GORIGHT);
<a name="l01401"></a>01401     setTabFocus();
<a name="l01402"></a>01402   }
<a name="l01403"></a>01403 
<a name="l01404"></a>01404   <span class="comment">// &quot;Event&quot; created internally when a list element moves from one</span>
<a name="l01405"></a>01405   <span class="comment">// list to another. This is called as a virtual function from</span>
<a name="l01406"></a>01406   <span class="comment">// StatusNotify.</span>
<a name="l01407"></a>01407   <span class="keywordtype">void</span> onDataChanged()
<a name="l01408"></a>01408   {
<a name="l01409"></a>01409     <span class="comment">// Notify all tabs that data has changed</span>
<a name="l01410"></a>01410     newTab-&gt;dataChanged();
<a name="l01411"></a>01411     freewareTab-&gt;dataChanged();
<a name="l01412"></a>01412     demoTab-&gt;dataChanged();
<a name="l01413"></a>01413     installedTab-&gt;dataChanged();
<a name="l01414"></a>01414 
<a name="l01415"></a>01415     <span class="comment">// Update tab status and titles</span>
<a name="l01416"></a>01416     setupTabs();
<a name="l01417"></a>01417   }
<a name="l01418"></a>01418 
<a name="l01419"></a>01419   <span class="comment">// Switches the selected tab to the &quot;Installed&quot; tab. This is a</span>
<a name="l01420"></a>01420   <span class="comment">// virtual function from StatusNotify.</span>
<a name="l01421"></a>01421   <span class="keywordtype">void</span> switchToInstalled()
<a name="l01422"></a>01422   {
<a name="l01423"></a>01423     installedTab-&gt;selectMe();
<a name="l01424"></a>01424     setTabFocus();
<a name="l01425"></a>01425   }
<a name="l01426"></a>01426 
<a name="l01427"></a>01427   <span class="keywordtype">void</span> onRefresh(wxCommandEvent &amp;event)
<a name="l01428"></a>01428   {
<a name="l01429"></a>01429     <span class="comment">// Did the user request a total refresh?</span>
<a name="l01430"></a>01430     <span class="keywordflow">if</span>(event.GetId() == myID_MENU_REFRESH_TOTAL)
<a name="l01431"></a>01431       {
<a name="l01432"></a>01432         <span class="keywordflow">if</span>(!ask(wxT(<span class="stringliteral">&quot;A full reload will takes some time to re-download all necessary data. Are you sure?&quot;</span>)))
<a name="l01433"></a>01433           <span class="keywordflow">return</span>;
<a name="l01434"></a>01434 
<a name="l01435"></a>01435         <span class="comment">// Configure the loading process to disregard all cached</span>
<a name="l01436"></a>01436         <span class="comment">// files.</span>
<a name="l01437"></a>01437         conf.updateTigs = <span class="keyword">true</span>;
<a name="l01438"></a>01438       }
<a name="l01439"></a>01439 
<a name="l01440"></a>01440     updateData(<span class="keyword">true</span>);
<a name="l01441"></a>01441     onDataChanged();
<a name="l01442"></a>01442   }
<a name="l01443"></a>01443 
<a name="l01444"></a>01444   <span class="keywordtype">void</span> onAbout(wxCommandEvent &amp;event)
<a name="l01445"></a>01445   {
<a name="l01446"></a>01446     std::string str = <span class="stringliteral">&quot;TIGGIT - The Indie Game Installer\nVersion &quot;</span> + version;
<a name="l01447"></a>01447     wxMessageBox(wxString(str.c_str(), wxConvUTF8), wxT(<span class="stringliteral">&quot;About&quot;</span>), wxOK);
<a name="l01448"></a>01448   }
<a name="l01449"></a>01449 
<a name="l01450"></a>01450   <span class="keywordtype">void</span> onExit(wxCommandEvent &amp;event)
<a name="l01451"></a>01451   {
<a name="l01452"></a>01452     Close();
<a name="l01453"></a>01453   }
<a name="l01454"></a>01454 
<a name="l01455"></a>01455   <span class="comment">// Called regularly by an external timer, used to update</span>
<a name="l01456"></a>01456   <span class="comment">// thread-dependent data</span>
<a name="l01457"></a>01457   <span class="keywordtype">void</span> tick()
<a name="l01458"></a>01458   {
<a name="l01459"></a>01459     <span class="comment">/* TODO: We have mixed up display stuff AND actual thread handling</span>
<a name="l01460"></a>01460 <span class="comment">       stuff in tick, so at the moment we have to update all tabs.</span>
<a name="l01461"></a>01461 <span class="comment"></span>
<a name="l01462"></a>01462 <span class="comment">       After we&#39;ve rewritten the thread system to handle itself more</span>
<a name="l01463"></a>01463 <span class="comment">       autonomously though, we&#39;ll only need to update the displayed</span>
<a name="l01464"></a>01464 <span class="comment">       tab since the ticks will be cosmetic.</span>
<a name="l01465"></a>01465 <span class="comment">    */</span>
<a name="l01466"></a>01466 
<a name="l01467"></a>01467     <span class="comment">/*</span>
<a name="l01468"></a>01468 <span class="comment">    TabBase *t = getCurrentTab();</span>
<a name="l01469"></a>01469 <span class="comment">    if(t) t-&gt;tick();</span>
<a name="l01470"></a>01470 <span class="comment">    */</span>
<a name="l01471"></a>01471     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;book-&gt;GetPageCount(); i++)
<a name="l01472"></a>01472       getTab(i)-&gt;tick();
<a name="l01473"></a>01473 
<a name="l01474"></a>01474     jobQueue.update();
<a name="l01475"></a>01475   }
<a name="l01476"></a>01476 };
<a name="l01477"></a>01477 
<a name="l01478"></a><a class="code" href="struct_my_timer.html">01478</a> <span class="keyword">struct </span><a class="code" href="struct_my_timer.html">MyTimer</a> : wxTimer
<a name="l01479"></a>01479 {
<a name="l01480"></a>01480   <a class="code" href="class_my_frame.html">MyFrame</a> *frame;
<a name="l01481"></a>01481 
<a name="l01482"></a>01482   <a class="code" href="struct_my_timer.html">MyTimer</a>(<a class="code" href="class_my_frame.html">MyFrame</a> *f)
<a name="l01483"></a>01483     : frame(f)
<a name="l01484"></a>01484   {
<a name="l01485"></a>01485     Start(500);
<a name="l01486"></a>01486   }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488   <span class="keywordtype">void</span> Notify()
<a name="l01489"></a>01489   {
<a name="l01490"></a>01490     frame-&gt;tick();
<a name="l01491"></a>01491   }
<a name="l01492"></a>01492 };
<a name="l01493"></a>01493 
<a name="l01494"></a><a class="code" href="class_my_app.html">01494</a> <span class="keyword">class </span><a class="code" href="class_my_app.html">MyApp</a> : <span class="keyword">public</span> wxApp
<a name="l01495"></a>01495 {
<a name="l01496"></a>01496   <a class="code" href="struct_my_timer.html">MyTimer</a> *time;
<a name="l01497"></a>01497 
<a name="l01498"></a>01498 <span class="keyword">public</span>:
<a name="l01499"></a>01499   <span class="keyword">virtual</span> <span class="keywordtype">bool</span> OnInit()
<a name="l01500"></a>01500   {
<a name="l01501"></a>01501     <span class="keywordflow">if</span> (!wxApp::OnInit())
<a name="l01502"></a>01502       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01503"></a>01503 
<a name="l01504"></a>01504     SetAppName(wxT(<span class="stringliteral">&quot;tiggit&quot;</span>));
<a name="l01505"></a>01505 
<a name="l01506"></a>01506     <span class="comment">// Set up the config directory</span>
<a name="l01507"></a>01507     wxString dataDir = wxStandardPaths::Get().GetUserLocalDataDir();
<a name="l01508"></a>01508     <span class="keyword">get</span>.setBase(<span class="keywordtype">string</span>(dataDir.mb_str()));
<a name="l01509"></a>01509 
<a name="l01510"></a>01510     <span class="keywordflow">try</span>
<a name="l01511"></a>01511       {
<a name="l01512"></a>01512         <span class="keywordtype">string</span> version;
<a name="l01513"></a>01513         {
<a name="l01514"></a>01514           <span class="comment">// Do auto update step. This requires us to immediately exit</span>
<a name="l01515"></a>01515           <span class="comment">// in some cases.</span>
<a name="l01516"></a>01516           <a class="code" href="struct_updater.html">Updater</a> upd(<span class="keyword">this</span>);
<a name="l01517"></a>01517           <span class="keywordflow">if</span>(upd.doAutoUpdate())
<a name="l01518"></a>01518             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01519"></a>01519 
<a name="l01520"></a>01520           version = upd.version;
<a name="l01521"></a>01521         }
<a name="l01522"></a>01522 
<a name="l01523"></a>01523         conf.load(<span class="keyword">get</span>.base);
<a name="l01524"></a>01524         auth.load();
<a name="l01525"></a>01525         ratings.read();
<a name="l01526"></a>01526 
<a name="l01527"></a>01527         <span class="comment">// Download cached data if this is the first time we run. This</span>
<a name="l01528"></a>01528         <span class="comment">// is much faster and more server-friendly than spawning a</span>
<a name="l01529"></a>01529         <span class="comment">// gazillion connections to get all the tigfiles and images</span>
<a name="l01530"></a>01530         <span class="comment">// individually.</span>
<a name="l01531"></a>01531         <span class="keywordflow">if</span>(conf.updateCache)
<a name="l01532"></a>01532           {
<a name="l01533"></a>01533             <a class="code" href="struct_cache_fetcher.html">CacheFetcher</a> cf(<span class="keyword">this</span>);
<a name="l01534"></a>01534             cf.goDoItAlready();
<a name="l01535"></a>01535           }
<a name="l01536"></a>01536 
<a name="l01537"></a>01537         updateData(conf.updateList);
<a name="l01538"></a>01538 
<a name="l01539"></a>01539         <span class="comment">//tig_reader.addTests(data);</span>
<a name="l01540"></a>01540 
<a name="l01541"></a>01541         wxInitAllImageHandlers();
<a name="l01542"></a>01542 
<a name="l01543"></a>01543         <span class="comment">// Do a full-scale image preload run. This will eat some</span>
<a name="l01544"></a>01544         <span class="comment">// bandwith and CPU the first time we run, but won&#39;t affect</span>
<a name="l01545"></a>01545         <span class="comment">// performance much on later runs. And in any case it&#39;s much</span>
<a name="l01546"></a>01546         <span class="comment">// preferable to waiting for each image to load.</span>
<a name="l01547"></a>01547 
<a name="l01548"></a>01548         <span class="comment">/* UPDATE: With our cache mechanism above, this is less</span>
<a name="l01549"></a>01549 <span class="comment">           necessary now.</span>
<a name="l01550"></a>01550 <span class="comment"></span>
<a name="l01551"></a>01551 <span class="comment">        for(int i=0; i&lt;data.arr.size(); i++)</span>
<a name="l01552"></a>01552 <span class="comment">          GameInfo::conv(data.arr[i]).requestShot();</span>
<a name="l01553"></a>01553 <span class="comment">        */</span>
<a name="l01554"></a>01554 
<a name="l01555"></a>01555         <a class="code" href="class_my_frame.html">MyFrame</a> *frame = <span class="keyword">new</span> <a class="code" href="class_my_frame.html">MyFrame</a>(wxT(<span class="stringliteral">&quot;Tiggit - The Indie Game Installer&quot;</span>),
<a name="l01556"></a>01556                                      version);
<a name="l01557"></a>01557         frame-&gt;Show(<span class="keyword">true</span>);
<a name="l01558"></a>01558         time = <span class="keyword">new</span> <a class="code" href="struct_my_timer.html">MyTimer</a>(frame);
<a name="l01559"></a>01559 
<a name="l01560"></a>01560         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01561"></a>01561       }
<a name="l01562"></a>01562     <span class="keywordflow">catch</span>(std::exception &amp;e)
<a name="l01563"></a>01563       {
<a name="l01564"></a>01564         wxString msg(e.what(), wxConvUTF8);
<a name="l01565"></a>01565         errorBox(msg);
<a name="l01566"></a>01566       }
<a name="l01567"></a>01567 
<a name="l01568"></a>01568     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01569"></a>01569   }
<a name="l01570"></a>01570 };
<a name="l01571"></a>01571 
<a name="l01572"></a>01572 IMPLEMENT_APP(<a class="code" href="class_my_app.html">MyApp</a>)
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Tue May 8 2012 21:03:46 for Tiggit by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.0
</small></address>

</body>
</html>
